<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>药品数据管理系统（带本地存储）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f7fee7;
        }
        
        .container {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: 1px solid #bef264;
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(217, 249, 157, 0.3);
            background-color: #fefee8;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            background-color: #f7fee7;
            border-radius: 10px;
            border: 1px solid #d9f99d;
            flex-wrap: nowrap;
            min-height: 70px;
        }
        
        #searchInput {
            flex: 1;
            min-width: 350px;
            padding: 14px 18px;
            border: 1px solid #d9f99d;
            border-radius: 8px;
            font-size: 18px;
            background-color: white;
            transition: all 0.3s;
            pointer-events: auto;
            cursor: text;
        }
        
        #searchInput:focus {
            outline: none;
            border-color: #a3e635;
            box-shadow: 0 0 0 4px rgba(163, 230, 53, 0.3);
        }
        
        /* 按钮样式 */
        .toolbar button {
            padding: 14px 24px;
            background-color: #a3e635;
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
            font-size: 18px;
            min-height: 50px;
            letter-spacing: 0.5px;
        }
        
        .toolbar button:hover {
            background-color: #84cc16;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(132, 204, 22, 0.4);
        }
        
        .toolbar button:active {
            transform: translateY(0);
        }
        
        #filterToggle.active {
            background-color: #84cc16;
        }
        
        .btn-disabled {
            background-color: #e9fbb8 !important;
            cursor: not-allowed !important;
            transform: none !important;
            opacity: 0.6;
        }
        
        #fileInput {
            display: none;
        }
        
        .table-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            border-radius: 10px;
            border: 1px solid #d9f99d;
            background-color: white;
            position: relative;
        }
        
        .table-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            width: 100%;
            height: 100%;
            scrollbar-width: thin;
            scrollbar-color: #a3e635 #f7fee7;
        }
        
        /* 自定义滚动条样式 - 右下角短滚动条 */
        .table-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background-color: #a3e635;
            border-radius: 6px;
            border: 2px solid #f7fee7;
        }
        
        /* 水平滚动条只显示在右下角，长度30% */
        .table-wrapper::-webkit-scrollbar:horizontal {
            height: 12px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:horizontal {
            background-color: #a3e635;
            border-radius: 6px;
            width: 30% !important;
            min-width: 60px;
            position: absolute;
            right: 0;
        }
        
        /* 垂直滚动条只显示在右下角，高度30% */
        .table-wrapper::-webkit-scrollbar:vertical {
            width: 12px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:vertical {
            background-color: #a3e635;
            border-radius: 6px;
            height: 30% !important;
            min-height: 60px;
            position: absolute;
            bottom: 0;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: #84cc16;
        }
        
        /* 右下角交叉区域样式 */
        .table-wrapper::-webkit-scrollbar-corner {
            background-color: #f7fee7;
            border-radius: 0 0 6px 0;
        }
        
        .table-container {
            min-width: 100%;
            width: max-content;
            background-color: white;
        }
        
        /* 表格核心样式 */
        table {
            width: max-content;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }
        
        /* 行号列样式 - 行号列宽度改为36px */
        th.row-header {
            background-color: #e5f5d7 !important;
            color: #3f6212 !important;
            font-weight: bold;
            text-align: center;
            width: 36px !important;
            min-width: 36px !important;
            max-width: 36px !important;
            cursor: pointer;
            border-right: 1px solid #84cc16 !important;
            position: sticky;
            left: 0;
            z-index: 3;
            padding: 3px 2px !important;
            font-size: 14px !important;
            height: 21px !important;
        }
        
        td.row-header {
            background-color: #f0f9e8 !important;
            color: #4d7c0f !important;
            font-weight: bold;
            text-align: center;
            width: 36px !important;
            min-width: 36px !important;
            max-width: 36px !important;
            cursor: pointer;
            border-right: 1px solid #84cc16 !important;
            position: sticky;
            left: 0;
            z-index: 2;
            padding: 3px 2px !important;
            font-size: 14px !important;
            height: 21px !important;
        }
        
        /* 新增：整行选中的模糊背景样式（不改变原有单元格选中样式） */
        tr.row-selected {
            background-color: rgba(224, 242, 254, 0.3) !important;
        }
        
        th {
            border: 1px solid #bef264 !important;
            padding: 3px 5px !important;
            text-align: left;
            min-width: 30px !important;
            max-width: 400px;
            background-color: #f7fee7;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
            line-height: 1.3;
            height: 21px !important;
            color: #4d7c0f;
            white-space: nowrap;
            font-size: 19px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 列宽调整手柄（右上角角标）- 核心优化 */
        .col-resize-handle {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            background-color: #a3e635;
            cursor: col-resize;
            z-index: 5;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .col-resize-handle:hover {
            opacity: 1;
            background-color: #84cc16;
        }
        
        /* L表头特殊样式 */
        th[data-header="L"] {
            background-color: #f0f9e8;
        }
        
        td {
            border: 1px solid #bef264 !important;
            padding: 3px 5px !important;
            text-align: left !important;
            min-width: 30px !important;
            max-width: 400px;
            line-height: 1.3;
            height: 21px !important;
            cursor: text;
            position: relative;
            background-color: white;
            user-select: none;
            font-size: 18px;
            overflow: hidden !important;
            white-space: nowrap;
            text-overflow: ellipsis;
            word-wrap: break-word;
            word-break: break-all;
            color: #333 !important;
        }
        
        /* A列特殊样式 - 保持123px不变 */
        td[data-col="A"],
        th[data-header="A"] {
            width: 123px !important;
            min-width: 123px !important;
            max-width: 123px !important;
        }
        
        /* C列特殊宽度 - 5个数字那么宽 */
        td[data-col="C"],
        th[data-header="C"] {
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
        }
        
        /* E列宽度与C列相同 - 5个数字那么宽 */
        td[data-col="E"],
        th[data-header="E"] {
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
        }
        
        /* D列和F列特殊宽度 - 只显示2个数字那么宽 */
        td[data-col="D"],
        td[data-col="F"] {
            width: 40px !important;
            min-width: 40px !important;
            max-width: 40px !important;
        }
        
        th[data-header="D"],
        th[data-header="F"] {
            width: 40px !important;
            min-width: 40px !important;
            max-width: 40px !important;
        }
        
        /* H到Z列特殊样式 - 保持146px不变 */
        td[data-col="H"],
        td[data-col="I"],
        td[data-col="J"],
        td[data-col="K"],
        td[data-col="L"],
        td[data-col="M"],
        td[data-col="N"],
        td[data-col="O"],
        td[data-col="P"],
        td[data-col="Q"],
        td[data-col="R"],
        td[data-col="S"],
        td[data-col="T"],
        td[data-col="U"],
        td[data-col="V"],
        td[data-col="W"],
        td[data-col="X"],
        td[data-col="Y"],
        td[data-col="Z"],
        th[data-header="H"],
        th[data-header="I"],
        th[data-header="J"],
        th[data-header="K"],
        th[data-header="L"],
        th[data-header="M"],
        th[data-header="N"],
        th[data-header="O"],
        th[data-header="P"],
        th[data-header="Q"],
        th[data-header="R"],
        th[data-header="S"],
        th[data-header="T"],
        th[data-header="U"],
        th[data-header="V"],
        th[data-header="W"],
        th[data-header="X"],
        th[data-header="Y"],
        th[data-header="Z"] {
            width: 146px !important;
            min-width: 146px !important;
            max-width: 146px !important;
        }
        
        /* 单元格内容容器 */
        .cell-content-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 18px;
            text-align: left !important;
            max-width: 100%;
            min-width: 0;
            flex-shrink: 1;
            padding: 0 !important;
            margin: 0 !important;
            padding-left: 2px !important;
            color: inherit !important;
        }
        
        /* 仅差异化设置内容字体，标题字体统一继承th的19px */
        td[data-col="A"] .cell-content-wrapper {
            font-size: 14px !important;
        }
        td[data-col="H"] .cell-content-wrapper,
        td[data-col="I"] .cell-content-wrapper,
        td[data-col="J"] .cell-content-wrapper,
        td[data-col="K"] .cell-content-wrapper,
        td[data-col="L"] .cell-content-wrapper,
        td[data-col="M"] .cell-content-wrapper,
        td[data-col="N"] .cell-content-wrapper,
        td[data-col="O"] .cell-content-wrapper,
        td[data-col="P"] .cell-content-wrapper,
        td[data-col="Q"] .cell-content-wrapper,
        td[data-col="R"] .cell-content-wrapper,
        td[data-col="S"] .cell-content-wrapper,
        td[data-col="T"] .cell-content-wrapper,
        td[data-col="U"] .cell-content-wrapper,
        td[data-col="V"] .cell-content-wrapper,
        td[data-col="W"] .cell-content-wrapper,
        td[data-col="X"] .cell-content-wrapper,
        td[data-col="Y"] .cell-content-wrapper,
        td[data-col="Z"] .cell-content-wrapper {
            font-size: 11px !important;
        }
        
        /* 可编辑单元格 */
        td.editable {
            outline: none;
            user-select: text;
        }
        
        td.editable:focus {
            background-color: #f7fee7;
            outline: 3px solid #a3e635;
            outline-offset: -2px;
        }
        
        /* 仅D列只读 */
        td[data-col="D"] {
            background-color: #fcfcec;
            color: #666;
            cursor: not-allowed;
            pointer-events: none;
            text-align: left !important;
        }
        
        /* 单元格颜色标记 - 统一背景色，字体强制黑色 */
        .cell-yellow { 
            background-color: #fff200 !important; 
        }
        .cell-red { 
            background-color: #ef5350 !important; 
        }
        .cell-pink { 
            background-color: #f8bbd9 !important; 
        }
        
        /* 重复项标红 - 与标红样式完全一致，背景#ef5350，字体黑色 */
        .duplicate-cell {
            background-color: #ef5350 !important;
            border: 1px solid #ef5350 !important;
        }
        
        /* 表头编辑样式 - 标题输入框保持19px */
        .header-cell {
            position: relative;
            text-align: left !important;
            overflow: hidden;
        }
        .header-cell input {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 3px 5px;
            border: 2px solid #a3e635;
            border-radius: 4px;
            outline: none;
            background: white;
            font-weight: bold;
            font-size: 19px !important;
            color: #4d7c0f;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .header-cell.editing input {
            display: block;
        }
        .header-cell span {
            display: block;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left !important;
            padding-left: 2px;
        }
        .header-cell.editing span {
            display: none;
        }
        
        /* I列表头链接样式 */
        .header-link {
            color: #1976d2 !important;
            cursor: pointer !important;
            text-decoration: underline !important;
            text-align: left !important;
            font-size: 19px !important;
        }
        .header-link:hover {
            color: #1565c0 !important;
            background-color: #f7fee7 !important;
        }
        
        /* 单元格选中样式 */
        .cell-selected {
            background-color: #e0f2fe !important;
            border: 2px solid #38bdf8 !important;
        }
        .cell-drag-selected {
            background-color: #e0f2fe !important;
            border: 1px solid #38bdf8 !important;
        }
        
        /* 拖选框样式 */
        .selection-box {
            position: absolute;
            background-color: rgba(56, 189, 248, 0.1);
            border: 2px solid #38bdf8;
            pointer-events: none;
            z-index: 100;
        }
        
        /* 右键菜单：备注功能与标颜色互换位置 - 所有批注改为备注 */
        .context-menu {
            position: absolute;
            width: 220px;
            background: white;
            border: 2px solid #d9f99d;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(217, 249, 157, 0.4);
            z-index: 1000;
            display: none;
        }
        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 17px;
        }
        .context-menu-item:hover {
            background-color: #f7fee7;
        }
        .context-menu-separator {
            height: 2px;
            background-color: #bef264;
            margin: 8px 0;
        }
        .menu-view-comment {
            color: #ef5350;
            font-weight: bold;
        }
        .menu-view-comment-text {
            color: #333;
            font-weight: normal;
            white-space: normal;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-top: 8px;
            padding: 10px;
            font-size: 16px;
        }
        
        /* 搜索高亮 */
        .search-highlight {
            background-color: #fef08a !important;
            border: 1px solid #fbbf24 !important;
        }
        
        /* 隐藏的行 */
        .hidden {
            display: none !important;
        }
        
        /* 存储状态提示 */
        .storage-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #a3e635;
            color: #333;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            opacity: 0.8;
            z-index: 9999;
            transition: opacity 0.3s;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .storage-status.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 0.9; transform: translateY(0); }
            80% { opacity: 0.9; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* Excel式备注弹出框 - 所有批注改为备注 */
        .cell-comment-popup {
            position: absolute;
            background-color: #ffffe1;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 8px 12px;
            font-size: 14px;
            max-width: 300px;
            min-width: 150px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            color: #333;
            pointer-events: none;
        }
        
        .cell-comment-popup::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 10px;
            width: 10px;
            height: 10px;
            background-color: #ffffe1;
            transform: rotate(45deg);
            border-left: 1px solid #ccc;
            border-top: 1px solid #ccc;
        }
        
        /* 备注右上方红点（仅保留这一个） */
        .comment-indicator {
            position: absolute;
            top: 1px;
            right: 1px;
            width: 6px;
            height: 6px;
            background-color: #ef5350;
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
        }
        
        /* 新增：单元格编辑输入框 */
        .cell-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-size: inherit;
            font-family: inherit;
            color: #333;
            padding: 3px 5px;
            margin: 0;
            z-index: 10;
            display: none;
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
        }
        
        /* 【核心修复】编辑状态下显示白色背景，防止看到下层静态文字 */
        .cell-input.editing {
            display: block;
            background-color: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js  "></script>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <input type="text" id="searchInput" placeholder="输入条码或药品名称，筛选A列或B列包含的内容...">
            <button id="filterToggle">筛选＞0</button>
            <button id="addRowBtn">新增药品</button>
            <button id="importBtn">导入Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xlsm">
            <button id="saveBtn">保存为Excel</button>
            <button id="undoBtn" class="btn-disabled">撤销 (Ctrl+Z)</button>
            <button id="redoBtn" class="btn-disabled">恢复 (Ctrl+Y)</button>
        </div>

        <div class="table-section">
            <div class="table-wrapper">
                <div class="table-container">
                    <table id="dataTable">
                        <thead class="sticky-header">
                            <tr id="tableHeaderRow"></tr>
                        </thead>
                        <tbody id="tableTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单：备注功能与标颜色互换位置 - 所有批注改为备注 -->
    <div class="context-menu" id="cellContextMenu">
        <div class="context-menu-item menu-view-comment" data-action="view-comment">
            查看备注
            <div id="commentPreview" class="menu-view-comment-text"></div>
        </div>
        <div class="context-menu-item" data-action="add-comment">添加备注</div>
        <div class="context-menu-item" data-action="clear-comment">清除备注</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="mark-red">标红</div>
        <div class="context-menu-item" data-action="mark-yellow">标黄</div>
        <div class="context-menu-item" data-action="mark-pink">标粉</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="clear-color">清除颜色</div>
    </div>

    <!-- Excel式备注弹出框 - 所有批注改为备注 -->
    <div class="cell-comment-popup" id="cellCommentPopup"></div>

    <!-- 存储状态提示 -->
    <div class="storage-status" id="storageStatus">数据已自动保存</div>

    <script>
        // 全局配置
        const CONFIG = {
            maxCol: 'Z',
            readOnlyCol: ['D'],
            calcHeaderCol: 'L',
            traceCodeCol: ['H','I','M','N'],
            countColForD: ['H','I','J','K','L','M','N'],
            formulaHeaderCols: ['J', 'K'],
            storageKey: 'medicine_data_system_v5'
        };
        
        // 全局变量
        let isFilterActive = false;
        let originalRows = [];
        let selectedCell = null;
        let selectedCells = new Set();
        let contextMenu = null;
        let commentPopup = null;
        let historyStack = [];
        let redoStack = [];
        let isUndoRedo = false;
        let colLetters = [];
        let isResizing = false;
        let resizeTh = null;
        let startX = 0;
        let startWidth = 0;
        let isDragging = false;
        let dragStartCell = null;
        let isCtrlPressed = false;
        let selectionBox = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let lastSearchTerm = '';
        let autoSaveTimer = null;
        let isInitializing = true;
        let commentMouseEnterTimer = null;
        let commentMouseLeaveTimer = null;
        let activeInput = null; // 当前活动的输入框

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            contextMenu = document.getElementById('cellContextMenu');
            commentPopup = document.getElementById('cellCommentPopup');
            colLetters = generateColLetters(CONFIG.maxCol);
            initTableHeader();
            
            // 先尝试从本地存储加载数据
            if (!loadFromLocalStorage()) {
                // 如果没有本地数据，加载示例数据
                initSampleData();
            }
            
            initColResize();
            originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            saveToHistory();
            initAllEvents();
            calcTargetHeader(CONFIG.calcHeaderCol);
            calculateDColumn();
            checkDuplicateCells();
            updateUndoRedoButtons();
            
            // 设置页面关闭时的自动保存
            window.addEventListener('beforeunload', function(e) {
                saveToLocalStorage();
            });
            
            // 初始化右键菜单事件 - 改为双击右键启用功能
            let lastRightClickTime = 0;
            const DOUBLE_RIGHT_CLICK_DELAY = 300; // 300ms内视为双击
            
            document.addEventListener('contextmenu', function(e) {
                const targetCell = e.target.closest('td.editable');
                if (!targetCell) return;
                
                const currentTime = new Date().getTime();
                const timeDiff = currentTime - lastRightClickTime;
                
                if (timeDiff < DOUBLE_RIGHT_CLICK_DELAY) {
                    // 双击右键 - 显示自定义菜单
                    e.preventDefault();
                    if (!selectedCells.has(targetCell)) { 
                        clearAllSelections(); 
                        selectCell(targetCell); 
                    }
                    updateContextMenu();
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    lastRightClickTime = 0; // 重置
                    return false;
                } else {
                    // 第一次右键点击，记录时间
                    lastRightClickTime = currentTime;
                    // 不阻止默认行为，允许显示浏览器默认菜单
                }
            }, true);
            
            isInitializing = false;
        });

        // 核心工具函数
        function generateColLetters(maxCol) {
            const letters = [];
            for (let i = 'A'.charCodeAt(0); i <= maxCol.charCodeAt(0); i++) {
                letters.push(String.fromCharCode(i));
            }
            return letters;
        }
        function getHeaderIndex(col) { return colLetters.indexOf(col); }
        function getHeaderCell(col) { return document.querySelector(`th[data-header="${col}"]`); }
        function getCellText(cell) {
            const wrapper = cell.querySelector('.cell-content-wrapper');
            return wrapper ? wrapper.textContent.trim() : '';
        }
        function setCellText(cell, text) {
            const wrapper = cell.querySelector('.cell-content-wrapper');
            if (wrapper) {
                wrapper.textContent = text;
                wrapper.style.paddingLeft = '2px';
                wrapper.style.marginLeft = '0';
            }
        }
        // 公式计算核心函数（支持+、-、*、/、()，以=或--开头，--自动转为=）
        function calculateFormula(formula) {
            if (!formula) return formula;
            // 核心修改：将--开头的内容自动转为=开头，实现--和=等效
            const newFormula = formula.startsWith('--') ? '=' + formula.slice(2) : formula;
            if (!newFormula.startsWith('=')) return formula;
            try {
                // 提取等号后表达式，做安全校验（仅保留数字、+-*/().）
                const expr = newFormula.slice(1).replace(/[^0-9\+\-\*\/\.\(\)]/g, '');
                if (!expr) return formula;
                // 安全执行表达式（避免恶意代码）
                const result = Function(`'use strict'; return (${expr})`)();
                // 非数字返回原公式，数字保留1位小数（统一格式）
                return isNaN(result) || !isFinite(result) ? formula : Number(result).toFixed(1);
            } catch (e) {
                // 公式错误返回原内容
                return formula;
            }
        }

        // 新增：根据点击X坐标精确计算光标位置（使用Canvas测量文本宽度）
        function positionCursorAtClick(input, clickX) {
            try {
                const style = window.getComputedStyle(input);
                const paddingLeft = parseFloat(style.paddingLeft) || 0;
                const borderLeft = parseFloat(style.borderLeftWidth) || 0;
                const inputRect = input.getBoundingClientRect();
                
                // 创建临时 canvas 测量文本宽度
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
                
                const text = input.value;
                const clickOffsetX = clickX - inputRect.left - paddingLeft - borderLeft;
                
                // 逐个测量找到最接近的字符位置
                let closestIndex = 0;
                let minDiff = Infinity;
                
                for (let i = 0; i <= text.length; i++) {
                    const width = ctx.measureText(text.substring(0, i)).width;
                    const diff = Math.abs(width - clickOffsetX);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }
                
                input.setSelectionRange(closestIndex, closestIndex);
            } catch (e) {
                // 如果计算失败，默认放在末尾
                input.setSelectionRange(input.value.length, input.value.length);
            }
        }

        // L表头自动计算
        function calcTargetHeader(targetCol) {
            const targetCell = getHeaderCell(targetCol);
            if (!targetCell) return;
            const targetIndex = getHeaderIndex(targetCol);
            const prev1Index = targetIndex - 1, prev2Index = targetIndex - 2;
            if (prev2Index < 0 || prev1Index < 0) {
                setCellText(targetCell, '列数不足');
                targetCell.querySelector('input').value = '列数不足';
                return;
            }
            const prev2Col = colLetters[prev2Index], prev1Col = colLetters[prev1Index];
            const prev2Val = parseFloat(getCellText(getHeaderCell(prev2Col))) || 0;
            const prev1Val = parseFloat(getCellText(getHeaderCell(prev1Col))) || 0;
            const result = (prev2Val - prev1Val).toFixed(1);
            setCellText(targetCell, result);
            targetCell.querySelector('input').value = result;
            calculateDColumn();
        }

        // 表格初始化 - E列标题为"hyj"，宽度与C列相同
        function initTableHeader() {
            const headerRow = document.getElementById('tableHeaderRow');
            // 行号列
            const rowNumHeader = document.createElement('th');
            rowNumHeader.className = 'row-header';
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '36px';
            headerRow.appendChild(rowNumHeader);
            // A-Z列 - 修改E列为"hyj"，F列为"上限"，G列为"备注"（批注改回备注）
            const headerText = {
                A: '条码', B: '药品名称', C: '价', D: '无', E: 'hyj', F: '上限', G: '备注',
                H: 'Q02000000', I: '点击访问网站', J: '240', K: '126.8', L: '计算值'
            };
            colLetters.forEach(col => {
                const th = document.createElement('th');
                th.className = 'header-cell';
                th.dataset.header = col;
                
                // 设置列宽 - 保持原有宽度不变
                if (col === 'A') {
                    th.style.width = '123px';
                    th.style.minWidth = '123px';
                } else if (col === 'C' || col === 'E') {
                    th.style.width = '70px';
                    th.style.minWidth = '70px';
                } else if (col === 'D' || col === 'F') {
                    th.style.width = '40px';
                    th.style.minWidth = '40px';
                } else if (col >= 'H' && col <= 'Z') {
                    th.style.width = '146px';
                    th.style.minWidth = '146px';
                } else {
                    th.style.width = '150px';
                    th.style.minWidth = '30px';
                }
                
                th.style.height = '21px';
                if (col === 'I') th.classList.add('header-link');
                if (col === CONFIG.calcHeaderCol) th.style.backgroundColor = '#f0f9e8';
                const text = headerText[col] || '';
                th.innerHTML = `<div class="cell-content-wrapper"><span>${text}</span></div><input type="text" value="${text}" data-header="${col}">`;
                // 添加列宽调整角标
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'col-resize-handle';
                th.appendChild(resizeHandle);
                headerRow.appendChild(th);
            });
        }

        // 示例数据
        function initSampleData() {
            const tbody = document.getElementById('tableTbody');
            // 行1
            const row1 = createNewRow(1);
            setCellText(row1.querySelector('[data-col="A"]'), '6934114761936');
            setCellText(row1.querySelector('[data-col="B"]'), 'bt生脉饮党参方盾克康福');
            setCellText(row1.querySelector('[data-col="C"]'), '62');
            setCellText(row1.querySelector('[data-col="E"]'), '35');
            setCellText(row1.querySelector('[data-col="F"]'), 'bt');
            setCellText(row1.querySelector('[data-col="G"]'), '');
            setCellText(row1.querySelector('[data-col="H"]'), '84680850001502374758');
            setCellText(row1.querySelector('[data-col="J"]'), '240');
            setCellText(row1.querySelector('[data-col="K"]'), '126.8');
            setCellText(row1.querySelector('[data-col="L"]'), '113.2');
            row1.querySelector('[data-col="B"]').classList.add('cell-yellow');
            row1.querySelector('[data-col="C"]').classList.add('cell-yellow');
            tbody.appendChild(row1);
            // 行2
            const row2 = createNewRow(2);
            setCellText(row2.querySelector('[data-col="A"]'), '6975782860026');
            setCellText(row2.querySelector('[data-col="B"]'), 'ybx橡一活络油医用退热凝胶湖北5');
            setCellText(row2.querySelector('[data-col="C"]'), '59');
            setCellText(row2.querySelector('[data-col="E"]'), '50');
            setCellText(row2.querySelector('[data-col="F"]'), '');
            setCellText(row2.querySelector('[data-col="G"]'), '');
            setCellText(row2.querySelector('[data-col="H"]'), '0');
            tbody.appendChild(row2);
        }

        // 创建新行 - 保持原有宽度不变
        function createNewRow(rowNum) {
            const tr = document.createElement('tr');
            // 行号单元格
            const rowNumCell = document.createElement('td');
            rowNumCell.className = 'row-header';
            rowNumCell.textContent = rowNum;
            rowNumCell.style.width = '36px';
            rowNumCell.style.height = '21px';
            tr.appendChild(rowNumCell);
            // 数据列
            colLetters.forEach(col => {
                const td = document.createElement('td');
                td.dataset.col = col;
                td.style.height = '21px';
                
                // 设置列宽 - 保持原有宽度不变
                if (col === 'A') {
                    td.style.width = '123px';
                    td.style.minWidth = '123px';
                } else if (col === 'C' || col === 'E') {
                    td.style.width = '70px';
                    td.style.minWidth = '70px';
                } else if (col === 'D' || col === 'F') {
                    td.style.width = '40px';
                    td.style.minWidth = '40px';
                } else if (col >= 'H' && col <= 'Z') {
                    td.style.width = '146px';
                    td.style.minWidth = '146px';
                } else {
                    td.style.width = '150px';
                    td.style.minWidth = '30px';
                }
                
                // 核心修改：不再使用contentEditable，而是添加输入框
                const wrapper = document.createElement('div');
                wrapper.className = 'cell-content-wrapper';
                td.appendChild(wrapper);
                
                // 添加输入框（默认隐藏）
                const input = document.createElement('input');
                input.className = 'cell-input';
                input.type = 'text';
                td.appendChild(input);
                
                if (CONFIG.readOnlyCol.includes(col)) {
                    td.classList.remove('editable');
                    setCellText(td, '0');
                    input.disabled = true;
                } else {
                    td.classList.add('editable');
                    if (CONFIG.traceCodeCol.includes(col)) td.classList.add('trace-code');
                    bindCellEvents(td, input);
                }
                td.style.overflow = 'hidden';
                td.style.textAlign = 'left';
                td.style.paddingLeft = '5px';
                tr.appendChild(td);
            });
            return tr;
        }

        // 列宽调整（右上角角标拖动）- 核心优化
        function initColResize() {
            document.querySelectorAll('.col-resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    resizeTh = this.parentElement;
                    startX = e.clientX;
                    startWidth = resizeTh.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    e.preventDefault();
                    e.stopPropagation();
                    document.body.style.userSelect = 'none';
                    document.body.style.webkitUserSelect = 'none';
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position: fixed;top:0;left:0;width:100%;height:100%;z-index:9999;cursor:col-resize;background:transparent;';
                    overlay.id = 'resize-overlay';
                    document.body.appendChild(overlay);
                });
            });
            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !resizeTh) return;
                const newWidth = Math.max(20, startWidth + (e.clientX - startX));
                resizeTh.style.width = `${newWidth}px`;
                resizeTh.style.minWidth = `${newWidth}px`;
                const colIndex = Array.from(resizeTh.parentElement.children).indexOf(resizeTh);
                const dataCol = colLetters[colIndex - 1];
                document.querySelectorAll(`#dataTable tbody td[data-col="${dataCol}"]`).forEach(td => {
                    td.style.width = `${newWidth}px`;
                    td.style.minWidth = `${newWidth}px`;
                });
                e.preventDefault();
                e.stopPropagation();
            });
            document.addEventListener('mouseup', function(e) {
                if (isResizing) {
                    const overlay = document.getElementById('resize-overlay');
                    overlay && overlay.remove();
                    isResizing = false;
                    resizeTh = null;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = '';
                    document.body.style.webkitUserSelect = '';
                    !isUndoRedo && saveToHistory();
                    saveToLocalStorageDelayed(); // 保存到本地存储
                }
            });
            document.addEventListener('mouseleave', function() {
                if (isResizing) {
                    const overlay = document.getElementById('resize-overlay');
                    overlay && overlay.remove();
                    isResizing = false;
                    resizeTh = null;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = '';
                    document.body.style.webkitUserSelect = '';
                }
            });
        }

        // 所有事件绑定
        function initAllEvents() {
            initSearchInput();
            initButtonEvents();
            initHeaderEditEvent(); // 修复J/K列表头编辑事件
            initContextMenuEvent();
            initKeyboardShortcut();
            initIHeaderLink(); // 修复后的I列链接跳转
            initDragSelection();
            initCommentPopup(); // 备注弹出框，批注改回备注
            initRowNumberClick(); // 新增：行号点击整行选中事件
            
            // 监听Ctrl键状态
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = true;
                }
            });
            document.addEventListener('keyup', function(e) {
                if (e.key === 'Control') {
                    isCtrlPressed = false;
                }
            });
            
            // 点击其他地方关闭输入框
            document.addEventListener('click', function(e) {
                if (activeInput && !activeInput.parentElement.contains(e.target)) {
                    finishCellEdit(activeInput);
                }
            });
        }

        // 核心修复：单元格事件绑定 - 使用输入框实现Excel式编辑
        // 核心修改：支持精确光标定位、逐字删除、部分文字选择
        function bindCellEvents(td, input) {
            if (!td.classList.contains('editable')) return;
            
            let prevValue = getCellText(td);
            
            // 双击开始编辑（全选）- 保持原有行为
            td.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                startCellEdit(td, input, true); // true = 全选
            });
            
            // 单击进入编辑模式（精确光标定位）- 核心修改
            td.addEventListener('click', function(e) {
                // 如果已经在编辑当前单元格，让浏览器自己处理（支持精确光标定位和文本选择）
                if (activeInput && activeInput.parentElement === td && activeInput.classList.contains('editing')) {
                    return; 
                }
                
                if (e.ctrlKey) {
                    toggleCellSelection(td);
                } else if (e.shiftKey && selectedCell) {
                    selectCellRange(selectedCell, td);
                } else { 
                    clearAllSelections(); 
                    selectCell(td); 
                    // 关键修改：单击立即进入编辑模式，并传递点击坐标以实现精确定位
                    startCellEdit(td, input, false, e.clientX); 
                }
                e.stopPropagation();
            });
            
            // 输入框事件 - 确保Backspace/Delete/方向键等编辑键正常工作
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishCellEdit(input);
                    handleEnterKeyMove(td);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelCellEdit(input, prevValue);
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    finishCellEdit(input);
                    handleTabKeyMove(td, e.shiftKey);
                }
                // 关键修改：Backspace、Delete、方向键、Shift+方向键、Ctrl+A/C/V等都不阻止
                // 让浏览器原生处理，支持逐字删除和部分文字选择
            });
            
            // 失去焦点时完成编辑
            input.addEventListener('blur', function() {
                finishCellEdit(input);
            });
            
            // F2键开始编辑（全选）- 保持原有行为
            td.addEventListener('keydown', function(e) {
                if (e.key === 'F2' && document.activeElement === td) {
                    e.preventDefault();
                    startCellEdit(td, input, true); // true = 全选
                }
            });
        }
        
        // 开始单元格编辑 - 核心修改：支持根据点击坐标精确定位光标
        function startCellEdit(td, input, selectAll = true, clickX = null) {
            if (activeInput && activeInput !== input) {
                finishCellEdit(activeInput);
            }
            
            const value = getCellText(td);
            input.value = value;
            input.classList.add('editing');
            input.focus({preventScroll: true});
            
            if (selectAll) {
                // 双击或F2时全选（原有行为）
                setTimeout(() => {
                    input.select();
                }, 10);
            } else if (clickX !== null && value.length > 0) {
                // 单击时根据点击位置精确放置光标（新增功能）
                setTimeout(() => {
                    positionCursorAtClick(input, clickX);
                }, 10);
            } else {
                // 默认将光标放在末尾
                setTimeout(() => {
                    input.setSelectionRange(value.length, value.length);
                }, 10);
            }
            
            activeInput = input;
            selectCell(td);
        }
        
        // 完成单元格编辑
        function finishCellEdit(input) {
            if (!input || !input.classList.contains('editing')) return;
            
            const td = input.parentElement;
            const newValue = input.value;
            const oldValue = getCellText(td);
            
            if (newValue !== oldValue) {
                setCellText(td, newValue);
                !isUndoRedo && saveToHistory();
                saveToLocalStorageDelayed();
                checkDuplicateCells();
                calculateDColumn();
                // 如果在筛选状态下编辑，需要更新originalRows以确保数据一致性
                updateOriginalRows();
            }
            
            input.classList.remove('editing');
            if (activeInput === input) {
                activeInput = null;
            }
            
            // 保持单元格选中状态
            if (td && document.activeElement === input) {
                td.focus();
            }
        }
        
        // 新增：更新originalRows以反映当前DOM状态
        function updateOriginalRows() {
            // 只有在非筛选状态下才更新originalRows，否则保持原始数据
            if (!isFilterActive) {
                originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            }
        }
        
        // 取消单元格编辑
        function cancelCellEdit(input, originalValue) {
            if (!input || !input.classList.contains('editing')) return;
            
            const td = input.parentElement;
            input.value = originalValue;
            input.classList.remove('editing');
            if (activeInput === input) {
                activeInput = null;
            }
            
            // 保持单元格选中状态
            if (td && document.activeElement === input) {
                td.focus();
            }
        }
        
        function handleEnterKeyMove(cell) {
            const row = cell.parentElement;
            const rows = Array.from(document.querySelectorAll('#dataTable tbody tr:not(.hidden)'));
            const currentRowIdx = rows.indexOf(row);
            const cells = Array.from(row.querySelectorAll('td.editable'));
            const currentCellIdx = cells.indexOf(cell);
            if (currentRowIdx < rows.length - 1) {
                const nextCell = rows[currentRowIdx + 1].querySelectorAll('td.editable')[currentCellIdx];
                nextCell && selectCell(nextCell);
                return;
            }
            selectCell(cell);
        }
        
        function handleTabKeyMove(cell, shiftKey) {
            const row = cell.parentElement;
            const cells = Array.from(row.querySelectorAll('td.editable'));
            const currentCellIdx = cells.indexOf(cell);
            
            if (shiftKey) {
                // Shift+Tab：向左移动
                if (currentCellIdx > 0) {
                    selectCell(cells[currentCellIdx - 1]);
                }
            } else {
                // Tab：向右移动
                if (currentCellIdx < cells.length - 1) {
                    selectCell(cells[currentCellIdx + 1]);
                }
            }
        }

        // 新增：行号点击整行选中事件（核心需求）
        function initRowNumberClick() {
            // 委托事件，兼容动态新增行
            document.getElementById('dataTable').addEventListener('click', function(e) {
                const rowHeader = e.target.closest('.row-header');
                if (!rowHeader) return; // 不是行号，直接返回
                const tr = rowHeader.parentElement;
                if (!tr || tr.tagName !== 'TR') return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // 清除所有选中（单元格+整行）
                clearAllSelections();
                document.querySelectorAll('#dataTable tr.row-selected').forEach(r => {
                    r.classList.remove('row-selected');
                });
                
                // 标记整行选中的模糊背景
                tr.classList.add('row-selected');
                
                // 选中当前行所有可编辑单元格（保持原有单元格选中逻辑）
                const editableCells = tr.querySelectorAll('td.editable');
                editableCells.forEach(cell => {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                });
                
                // 设置默认选中单元格为第一个可编辑单元格
                if (editableCells.length > 0) {
                    selectedCell = editableCells[0];
                    selectedCell.style.outline = '3px solid #a3e635';
                    selectedCell.focus();
                }
            });
        }

        // 初始化Excel式备注弹出功能 - 所有批注改为备注
        function initCommentPopup() {
            // 为所有有备注的单元格添加鼠标事件
            document.addEventListener('mouseover', function(e) {
                const cell = e.target.closest('td[data-col]');
                if (cell && cell.dataset.comment) {
                    clearTimeout(commentMouseLeaveTimer);
                    commentMouseEnterTimer = setTimeout(() => {
                        showCellComment(cell, e.clientX, e.clientY);
                    }, 500); // 延迟500ms显示
                }
            });
            
            document.addEventListener('mouseout', function(e) {
                const cell = e.target.closest('td[data-col]');
                if (cell && cell.dataset.comment) {
                    clearTimeout(commentMouseEnterTimer);
                    commentMouseLeaveTimer = setTimeout(() => {
                        hideCellComment();
                    }, 300); // 延迟300ms隐藏
                }
            });
            
            // 鼠标移动到备注弹出框上时不清除
            commentPopup.addEventListener('mouseover', function() {
                clearTimeout(commentMouseLeaveTimer);
            });
            
            commentPopup.addEventListener('mouseout', function() {
                commentMouseLeaveTimer = setTimeout(() => {
                    hideCellComment();
                }, 300);
            });
        }
        
        function showCellComment(cell, mouseX, mouseY) {
            const comment = cell.dataset.comment;
            if (!comment) return;
            
            commentPopup.textContent = comment;
            commentPopup.style.display = 'block';
            
            // 计算位置
            const popupWidth = commentPopup.offsetWidth;
            const popupHeight = commentPopup.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // 默认显示在鼠标右下方
            let left = mouseX + 10;
            let top = mouseY + 10;
            
            // 如果右侧空间不足，显示在左侧
            if (left + popupWidth > windowWidth - 10) {
                left = mouseX - popupWidth - 10;
            }
            
            // 如果底部空间不足，显示在上方
            if (top + popupHeight > windowHeight - 10) {
                top = mouseY - popupHeight - 10;
            }
            
            commentPopup.style.left = left + 'px';
            commentPopup.style.top = top + 'px';
        }
        
        function hideCellComment() {
            commentPopup.style.display = 'none';
        }

        // 搜索功能 - 删除实时搜索，只保留回车搜索，删除未找到弹窗
        function initSearchInput() {
            const searchInput = document.getElementById('searchInput');
            
            // 实时输入只处理清空，不处理搜索（用户要求只用回车搜索）
            searchInput.addEventListener('input', function() {
                const term = this.value.trim();
                if (term === '' && lastSearchTerm !== '') {
                    // 清空搜索框时显示所有行
                    clearSearchHighlights();
                    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                        row.classList.remove('hidden');
                    });
                    lastSearchTerm = '';
                    !isUndoRedo && saveToHistory();
                }
                // 删除实时搜索功能：不再在term !== ''时调用performSearch
            });
            
            searchInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    performSearch(); 
                }
            });
        }
        
        function performSearch() {
            const term = document.getElementById('searchInput').value.trim();
            lastSearchTerm = term;
            
            if (!term) {
                clearSearchHighlights();
                document.querySelectorAll('#dataTable tbody tr').forEach(row => row.classList.remove('hidden'));
                saveToHistory();
                return;
            }
            
            clearSearchHighlights();
            
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const aCell = row.querySelector('[data-col="A"]');
                const bCell = row.querySelector('[data-col="B"]');
                const aText = getCellText(aCell).toLowerCase();
                const bText = getCellText(bCell).toLowerCase();
                const termLower = term.toLowerCase();
                const match = aText.includes(termLower) || bText.includes(termLower);
                
                if (match) {
                    row.classList.remove('hidden');
                    // 高亮匹配的单元格
                    if (aText.includes(termLower)) {
                        aCell.classList.add('search-highlight');
                    }
                    if (bText.includes(termLower)) {
                        bCell.classList.add('search-highlight');
                    }
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // 删除未找到匹配行的弹窗提醒
            !isUndoRedo && saveToHistory();
        }
        
        function clearSearchHighlights() {
            document.querySelectorAll('.search-highlight').forEach(cell => {
                cell.classList.remove('search-highlight');
            });
        }

        // 按钮事件 - 已删除清除本地数据按钮相关代码
        function initButtonEvents() {
            document.getElementById('filterToggle').addEventListener('click', function() {
                isFilterActive = !isFilterActive;
                toggleDColumnFilter();
                this.classList.toggle('active', isFilterActive);
                saveToLocalStorageDelayed(); // 保存到本地存储
            });
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            document.getElementById('fileInput').addEventListener('change', handleExcelImport);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('saveBtn').addEventListener('click', saveToExcel);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
        }

        // 修复J/K列表头编辑事件 - 移除不必要的判断，确保所有header-cell均可编辑（除I列链接）
        function initHeaderEditEvent() {
            document.querySelectorAll('.header-cell:not(.header-link)').forEach(cell => {
                const input = cell.querySelector('input');
                const col = cell.dataset.header;
                // 移除原有事件拦截，直接绑定点击编辑
                cell.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡，避免被其他事件拦截
                    cell.classList.add('editing');
                    input.value = getCellText(cell);
                    input.focus();
                    input.select(); // 选中输入框内容，方便直接编辑
                });
                // 表头编辑完成（失焦/回车）- J/K列执行公式计算（支持--和=）
                const finishEdit = () => {
                    cell.classList.remove('editing');
                    // 公式计算仅对J/K列生效，其他列直接取输入值
                    const finalValue = CONFIG.formulaHeaderCols.includes(col) 
                        ? calculateFormula(input.value) 
                        : input.value;
                    // 内容变化才更新，避免重复计算
                    if (getCellText(cell) !== finalValue) {
                        setCellText(cell, finalValue);
                        input.value = finalValue; // 同步输入框值
                        calcTargetHeader(CONFIG.calcHeaderCol); // 重新计算L列
                        !isUndoRedo && saveToHistory();
                        saveToLocalStorageDelayed();
                    }
                };
                input.addEventListener('blur', finishEdit);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') { 
                        e.preventDefault(); 
                        finishEdit(); 
                    }
                });
                // 阻止输入框事件冒泡
                input.addEventListener('click', e => e.stopPropagation());
            });
        }

        // 拖选功能
        function initDragSelection() {
            selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box';
            selectionBox.style.display = 'none';
            document.querySelector('.table-wrapper').appendChild(selectionBox);
            document.addEventListener('keydown', function(e) { isCtrlPressed = e.ctrlKey; });
            document.addEventListener('keyup', function(e) { isCtrlPressed = e.ctrlKey; });
            document.querySelectorAll('#dataTable td.editable').forEach(td => {
                td.addEventListener('mousedown', function(e) {
                    if (isCtrlPressed && e.button === 0) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!e.shiftKey) clearAllSelections();
                        isDragging = true;
                        dragStartCell = this;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                        const rect = this.getBoundingClientRect();
                        const tableRect = document.querySelector('.table-wrapper').getBoundingClientRect();
                        selectionBox.style.left = (rect.left - tableRect.left) + 'px';
                        selectionBox.style.top = (rect.top - tableRect.top) + 'px';
                        selectionBox.style.width = rect.width + 'px';
                        selectionBox.style.height = rect.height + 'px';
                        selectionBox.style.display = 'block';
                        if (!selectedCells.has(this)) {
                            selectedCells.add(this);
                            this.classList.add('cell-drag-selected');
                        }
                        document.body.style.cursor = 'crosshair';
                        return false;
                    }
                });
            });
            document.addEventListener('mousemove', function(e) {
                if (!isDragging || !dragStartCell) return;
                e.preventDefault();
                const tableWrapper = document.querySelector('.table-wrapper');
                const tableRect = tableWrapper.getBoundingClientRect();
                const startRect = dragStartCell.getBoundingClientRect();
                const currentX = e.clientX;
                const currentY = e.clientY;
                const left = Math.min(startRect.left, currentX);
                const top = Math.min(startRect.top, currentY);
                const right = Math.max(startRect.right, currentX);
                const bottom = Math.max(startRect.bottom, currentY);
                selectionBox.style.left = (left - tableRect.left) + 'px';
                selectionBox.style.top = (top - tableRect.top) + 'px';
                selectionBox.style.width = (right - left) + 'px';
                selectionBox.style.height = (bottom - top) + 'px';
                selectCellsInArea(left, top, right, bottom);
            });
            document.addEventListener('mouseup', function(e) {
                if (isDragging) {
                    isDragging = false;
                    selectionBox.style.display = 'none';
                    document.body.style.cursor = 'default';
                    updateDragSelectedCells();
                    !isUndoRedo && saveToHistory();
                    saveToLocalStorageDelayed(); // 保存到本地存储
                    dragStartCell = null;
                }
            });
        }
        function selectCellsInArea(left, top, right, bottom) {
            document.querySelectorAll('.cell-drag-selected').forEach(cell => {
                if (!selectedCells.has(cell)) cell.classList.remove('cell-drag-selected');
            });
            document.querySelectorAll('#dataTable td.editable').forEach(td => {
                const rect = td.getBoundingClientRect();
                if (rect.right > left && rect.left < right && rect.bottom > top && rect.top < bottom) {
                    if (!selectedCells.has(td)) {
                        selectedCells.add(td);
                        td.classList.add('cell-drag-selected');
                    }
                } else if (!selectedCells.has(td)) {
                    td.classList.remove('cell-drag-selected');
                }
            });
        }
        function updateDragSelectedCells() {
            selectedCells.forEach(cell => {
                cell.classList.remove('cell-drag-selected');
                cell.classList.add('cell-selected');
            });
        }

        // 右键菜单
        function updateContextMenu() {
            const commentPreview = document.getElementById('commentPreview');
            if (selectedCells.size > 0) {
                let allComments = [];
                selectedCells.forEach(cell => { if (cell.dataset.comment) allComments.push(cell.dataset.comment); });
                commentPreview.innerHTML = allComments.length > 0 ? allComments.join('<br>---<br>') : '无备注';
                commentPreview.style.display = 'block';
            } else if (selectedCell && selectedCell.tagName === 'TD') {
                commentPreview.innerHTML = selectedCell.dataset.comment || '无备注';
                commentPreview.style.display = 'block';
            } else {
                commentPreview.innerHTML = '';
                commentPreview.style.display = 'none';
            }
        }
        
        function initContextMenuEvent() {
            contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (!selectedCell && selectedCells.size === 0) return;
                    const action = this.dataset.action;
                    if (action === 'view-comment') { 
                        showCommentDialog(); 
                        contextMenu.style.display = 'none'; 
                        return; 
                    }
                    let cellsToProcess = selectedCells.size > 0 ? Array.from(selectedCells) : (selectedCell ? [selectedCell] : []);
                    cellsToProcess.forEach(cell => {
                        if (!cell || cell.tagName !== 'TD') return;
                        switch(action) {
                            case 'mark-red': setCellColor(cell, 'red'); break;
                            case 'mark-yellow': setCellColor(cell, 'yellow'); break;
                            case 'mark-pink': setCellColor(cell, 'pink'); break;
                            case 'add-comment': addCellComment(cell); break; // 备注
                            case 'clear-comment': clearCellComment(cell); break; // 备注
                            case 'clear-color': setCellColor(cell, 'clear'); break;
                        }
                    });
                    if (['mark-red','mark-yellow','mark-pink','clear-color','add-comment','clear-comment'].includes(action)) {
                        !isUndoRedo && saveToHistory();
                        saveToLocalStorageDelayed(); // 保存到本地存储
                    }
                    contextMenu.style.display = 'none';
                });
            });
            document.addEventListener('click', () => { 
                contextMenu.style.display = 'none'; 
            });
        }
        
        // 查看备注弹窗 - 所有批注改为备注
        function showCommentDialog() {
            let comments = [];
            const cellsToCheck = selectedCells.size > 0 ? Array.from(selectedCells) : (selectedCell ? [selectedCell] : []);
            cellsToCheck.forEach(cell => {
                if (cell && cell.dataset.comment) {
                    const row = cell.parentElement;
                    const rowNum = row.querySelector('.row-header').textContent;
                    comments.push(`第${rowNum}行 ${cell.dataset.col}列: ${cell.dataset.comment}`);
                }
            });
            const commentText = comments.length > 0 ? comments.join('\n\n') : '无备注信息';
            alert(`单元格备注：\n\n${commentText}`);
        }

        // I列表头链接 - 修复点击无反应问题，保留直接点击打开/拦截提示/备用跳转，无其他修改
        function initIHeaderLink() {
            const iHeader = document.querySelector('.header-link');
            if (!iHeader) return;
            // 直接绑定点击事件，移除重复的事件清除逻辑（核心修复）
            iHeader.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const targetUrl = 'https://www.mashangfangxin.com/  ';
                // 尝试打开新标签
                const newTab = window.open(targetUrl, '_blank', 'noopener,noreferrer');
                // 浏览器拦截时的备用方案（原有逻辑不变）
                if (!newTab || newTab.closed || typeof newTab === 'undefined') {
                    alert('跳转被浏览器拦截！请允许弹窗，或手动访问：\n' + targetUrl);
                    const tempLink = document.createElement('a');
                    tempLink.href = targetUrl;
                    tempLink.target = '_blank';
                    tempLink.rel = 'noopener noreferrer';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                }
            });
            // 阻止右键菜单（原有逻辑不变）
            iHeader.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        }

        // 键盘快捷键（新增Ctrl+Home/Ctrl+End）- 核心需求
        // 【核心修复】添加编辑状态检测，防止Backspace在编辑时全删，并确保搜索框可正常编辑
        function initKeyboardShortcut() {
            document.addEventListener('keydown', function(e) {
                // 【核心修复 START】如果正在编辑单元格或搜索框，让输入框自己处理按键（除了Esc和特定全局快捷键）
                const activeElement = document.activeElement;
                const isSearchBox = activeElement === document.getElementById('searchInput');
                const isCellInput = activeElement && activeElement.classList.contains('cell-input');
                
                if (isSearchBox || isCellInput) {
                    // 在输入框中时，只处理Escape退出编辑，其他键（Backspace、Delete等）都由输入框原生处理
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        if (isCellInput) {
                            const td = activeElement.parentElement;
                            const originalValue = getCellText(td);
                            cancelCellEdit(activeElement, originalValue);
                        }
                    }
                    // 允许Ctrl+Home/End等全局快捷键通过，其他直接返回
                    if (!(e.ctrlKey && (e.key === 'Home' || e.key === 'End'))) {
                        return;
                    }
                }
                // 【核心修复 END】
                
                // Ctrl+Z 撤销
                if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); return; }
                // Ctrl+Y 恢复
                if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); return; }
                // Ctrl+Home 回到首行首个可编辑单元格
                if (e.ctrlKey && e.key === 'Home') {
                    e.preventDefault();
                    const firstRow = document.querySelector('#dataTable tbody tr');
                    if (firstRow) {
                        const firstCell = firstRow.querySelector('td.editable');
                        firstCell && selectCell(firstCell);
                    }
                    return;
                }
                // Ctrl+End 回到最后一行最后一个可编辑单元格
                if (e.ctrlKey && e.key === 'End') {
                    e.preventDefault();
                    const rows = document.querySelectorAll('#dataTable tbody tr');
                    if (rows.length > 0) {
                        const lastRow = rows[rows.length - 1];
                        const editableCells = lastRow.querySelectorAll('td.editable');
                        if (editableCells.length > 0) {
                            const lastCell = editableCells[editableCells.length - 1];
                            selectCell(lastCell);
                        }
                    }
                    return;
                }
                // Delete/Backspace 清除选中内容（仅在未编辑状态下触发，且焦点不在搜索框）
                if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCells.size > 0) {
                    e.preventDefault();
                    // 判断是否为整行选中（存在row-selected类的行，且选中的是该行所有可编辑单元格）
                    const selectedRows = document.querySelectorAll('#dataTable tr.row-selected');
                    if (selectedRows.length === 1) {
                        clearSelectedRow(selectedRows[0]); // 整行清除：内容+格式+备注
                    } else {
                        clearSelectedCells(); // 单元格清除：仅清内容，保留格式
                    }
                    return;
                }
                // F2键开始编辑当前选中单元格
                if (e.key === 'F2' && selectedCell && selectedCell.tagName === 'TD' && selectedCell.classList.contains('editable')) {
                    e.preventDefault();
                    const input = selectedCell.querySelector('.cell-input');
                    if (input) {
                        startCellEdit(selectedCell, input, true); // F2时全选
                    }
                    return;
                }
                // 方向键导航
                if (selectedCell && selectedCell.tagName === 'TD' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    const row = selectedCell.parentElement;
                    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr:not(.hidden)'));
                    const currentRowIndex = rows.indexOf(row);
                    const cells = Array.from(row.querySelectorAll('td.editable'));
                    const currentCellIndex = cells.indexOf(selectedCell);
                    switch(e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            if (currentRowIndex > 0) {
                                const targetCell = rows[currentRowIndex-1].querySelectorAll('td.editable')[currentCellIndex];
                                targetCell && selectCell(targetCell);
                            }
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            if (currentRowIndex < rows.length-1) {
                                const targetCell = rows[currentRowIndex+1].querySelectorAll('td.editable')[currentCellIndex];
                                targetCell && selectCell(targetCell);
                            }
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            currentCellIndex > 0 && selectCell(cells[currentCellIndex-1]);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            currentCellIndex < cells.length-1 && selectCell(cells[currentCellIndex+1]);
                            break;
                    }
                }
            });
        }

        // 核心新增：整行清除（内容+所有颜色格式+备注）
        function clearSelectedRow(row) {
            if (!row || row.tagName !== 'TR') return;
            // 获取该行所有单元格（含只读D列，D列仅清计算值，恢复为0）
            const allCells = row.querySelectorAll('td[data-col]');
            allCells.forEach(cell => {
                // 1. 清除内容：D列恢复为0，其他列清空
                if (CONFIG.readOnlyCol.includes(cell.dataset.col)) {
                    setCellText(cell, '0');
                } else {
                    setCellText(cell, '');
                }
                // 2. 清除所有颜色格式
                cell.classList.remove('cell-red', 'cell-yellow', 'cell-pink', 'duplicate-cell', 'search-highlight');
                // 3. 清除备注及红点指示器
                clearCellComment(cell);
            });
            // 清除整行选中样式
            row.classList.remove('row-selected');
            // 清除单元格选中状态
            clearAllSelections();
            // 保存历史+本地存储，重新计算D列和重复项
            !isUndoRedo && saveToHistory();
            saveToLocalStorageDelayed();
            calculateDColumn();
            checkDuplicateCells();
        }

        // 清除选中单元格内容（仅清内容，保留格式）- 原有逻辑不变
        function clearSelectedCells() {
            if (selectedCells.size === 0) return;
            const editableCells = Array.from(selectedCells).filter(cell => {
                return cell.classList.contains('editable') && !cell.classList.contains('row-header');
            });
            if (editableCells.length === 0) return;
            editableCells.forEach(cell => {
                setCellText(cell, '');
            });
            !isUndoRedo && saveToHistory();
            saveToLocalStorageDelayed(); // 保存到本地存储
            checkDuplicateCells();
            calculateDColumn();
        }

        // 业务功能
        function selectCell(cell) {
            // 清除整行选中样式
            document.querySelectorAll('#dataTable tr.row-selected').forEach(r => {
                r.classList.remove('row-selected');
            });
            // 清除单元格选中
            clearAllSelections();
            selectedCell = cell;
            if (cell.tagName === 'TD') {
                cell.style.outline = '3px solid #a3e635';
                cell.classList.add('cell-selected');
                selectedCells.add(cell);
                cell.focus();
            }
        }
        
        function clearAllSelections() {
            selectedCells.forEach(cell => {
                cell.classList.remove('cell-selected');
                cell.style.outline = '';
            });
            selectedCells.clear();
            selectedCell = null;
        }
        
        function toggleCellSelection(cell) {
            if (selectedCells.has(cell)) {
                selectedCells.delete(cell);
                cell.classList.remove('cell-selected');
                if (selectedCell === cell) selectedCell = selectedCells.size > 0 ? Array.from(selectedCells).pop() : null;
            } else {
                selectedCells.add(cell);
                cell.classList.add('cell-selected');
                selectedCell = cell;
            }
            if (selectedCell) selectedCell.style.outline = '3px solid #a3e635';
        }
        
        function selectCellRange(startCell, endCell) {
            clearAllSelections();
            const startRow = startCell.parentElement, endRow = endCell.parentElement;
            const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            const startRowIdx = rows.indexOf(startRow), endRowIdx = rows.indexOf(endRow);
            const startColIdx = getHeaderIndex(startCell.dataset.col), endColIdx = getHeaderIndex(endCell.dataset.col);
            const minRow = Math.min(startRowIdx, endRowIdx), maxRow = Math.max(startRowIdx, endRowIdx);
            const minCol = Math.min(startColIdx, endColIdx), maxCol = Math.max(startColIdx, endColIdx);
            for (let i = minRow; i <= maxRow; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td.editable');
                for (let j = minCol; j <= maxCol; j++) {
                    const cell = cells[j];
                    if (cell) {
                        selectedCells.add(cell);
                        cell.classList.add('cell-selected');
                    }
                }
            }
            selectedCell = endCell;
            selectedCell.style.outline = '3px solid #a3e635';
        }
        
        function addNewRow() {
            const tbody = document.getElementById('tableTbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = createNewRow(rowCount + 1);
            tbody.appendChild(newRow);
            
            // 如果在筛选状态下添加新行，需要确保originalRows包含所有行（包括新添加的）
            if (isFilterActive) {
                // 先添加到DOM，然后更新originalRows，重新应用筛选
                originalRows.push(newRow);
                // 重新绑定事件
                const input = newRow.querySelector('.cell-input');
                if (input) {
                    bindCellEvents(newRow.querySelector('td.editable'), input);
                }
                // 重新应用筛选以显示新行（如果符合条件）
                applyFilter();
            } else {
                originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            }
            
            selectCell(newRow.querySelector('td.editable'));
            calculateDColumn();
            checkDuplicateCells();
            !isUndoRedo && saveToHistory();
            saveToLocalStorageDelayed(); // 保存到本地存储
        }
        
        // 新增：应用筛选功能（不切换状态）
        function applyFilter() {
            if (!isFilterActive) return;
            
            const tbody = document.getElementById('tableTbody');
            tbody.innerHTML = '';
            
            const filtered = originalRows.filter(row => {
                const dCell = row.querySelector('td[data-col="D"]');
                const dVal = parseFloat(getCellText(dCell)) || 0;
                return dVal > 0;
            }).sort((a, b) => {
                const aCell = a.querySelector('td[data-col="C"]');
                const bCell = b.querySelector('td[data-col="C"]');
                const aVal = parseFloat(getCellText(aCell)) || 0;
                const bVal = parseFloat(getCellText(bCell)) || 0;
                return bVal - aVal;
            });
            
            filtered.forEach((row, index) => {
                const rowNumCell = row.querySelector('.row-header');
                if (rowNumCell) rowNumCell.textContent = index + 1;
                tbody.appendChild(row);
            });
        }
        
        function toggleDColumnFilter() {
            const tbody = document.getElementById('tableTbody');
            tbody.innerHTML = '';
            
            if (isFilterActive) {
                // 筛选模式：只显示D>0的行，并按C列排序
                const filtered = originalRows.filter(row => {
                    const dCell = row.querySelector('td[data-col="D"]');
                    const dVal = parseFloat(getCellText(dCell)) || 0;
                    return dVal > 0;
                }).sort((a, b) => {
                    const aCell = a.querySelector('td[data-col="C"]');
                    const bCell = b.querySelector('td[data-col="C"]');
                    const aVal = parseFloat(getCellText(aCell)) || 0;
                    const bVal = parseFloat(getCellText(bCell)) || 0;
                    return bVal - aVal;
                });
                
                filtered.forEach((row, index) => {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = index + 1;
                    tbody.appendChild(row);
                });
            } else {
                // 非筛选模式：显示所有行，按原始顺序
                // 确保originalRows是最新的
                if (originalRows.length === 0) {
                    originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
                }
                
                originalRows.forEach((row, index) => {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = index + 1;
                    row.classList.remove('hidden');
                    tbody.appendChild(row);
                });
            }
            
            !isUndoRedo && saveToHistory();
            saveToLocalStorageDelayed(); // 保存到本地存储
        }
        
        function calculateDColumn() {
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const dCell = row.querySelector('[data-col="D"]');
                if (!dCell) return;
                let count = 0;
                CONFIG.countColForD.forEach(col => {
                    const cell = row.querySelector(`[data-col="${col}"]`);
                    if (getCellText(cell) !== '') count++;
                });
                setCellText(dCell, count.toString());
            });
        }
        
        function checkDuplicateCells() {
            const excludeCols = ['C','D','E','F','G'];
            const valueMap = new Map();
            document.querySelectorAll('#dataTable tbody td[data-col]').forEach(cell => {
                const col = cell.dataset.col;
                const text = getCellText(cell).trim();
                if (excludeCols.includes(col) || !text) return;
                const numValue = parseFloat(text);
                if (!isNaN(numValue) && numValue >= 0 && numValue <= 10) return;
                if (!valueMap.has(text)) valueMap.set(text, []);
                valueMap.get(text).push(cell);
            });
            document.querySelectorAll('.duplicate-cell').forEach(cell => cell.classList.remove('duplicate-cell'));
            valueMap.forEach((cells, val) => {
                if (cells.length > 1) cells.forEach(cell => cell.classList.add('duplicate-cell'));
            });
        }
        
        // 添加备注：移除has-comment类，仅保留右上角红点
        function addCellComment(cell) {
            clearCellComment(cell);
            const comment = prompt('请输入备注：', cell.dataset.comment || ''); // 批注改回备注
            if (comment === null || comment.trim() === '') return;
            cell.dataset.comment = comment.trim();
            
            // 仅添加右上方红点指示器
            const existingIndicator = cell.querySelector('.comment-indicator');
            if (!existingIndicator) {
                const indicator = document.createElement('div');
                indicator.className = 'comment-indicator';
                cell.appendChild(indicator);
            }
        }
        
        // 清除备注：移除has-comment类，仅移除红点指示器
        function clearCellComment(cell) {
            delete cell.dataset.comment;
            
            // 移除右上方红点指示器
            const indicator = cell.querySelector('.comment-indicator');
            if (indicator) {
                cell.removeChild(indicator);
            }
        }
        
        // 设置单元格颜色 - 移除字体颜色修改，仅保留背景色变化
        function setCellColor(cell, color) {
            cell.classList.remove('cell-red', 'cell-yellow', 'cell-pink');
            if (color !== 'clear') cell.classList.add(`cell-${color}`);
            // 移除所有字体颜色设置代码，确保字体始终为黑色
        }

        // Excel导入（同步颜色/备注）- 确保备注同步到悬浮备注，移除has-comment类
        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file || !['xlsx','xlsm'].includes(file.name.split('.').pop().toLowerCase())) {
                alert('仅支持.xlsx/.xlsm格式！');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { 
                        type: 'array',
                        cellStyles: true,
                        cellComments: true
                    });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
                    const cellRefs = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
                    if (data.length <= 1) { alert('无有效数据！'); return; }
                    const tbody = document.getElementById('tableTbody');
                    tbody.innerHTML = '';
                    // 计算列宽
                    const colMaxLengths = new Array(colLetters.length).fill(0);
                    const headerRow = data[0] || [];
                    headerRow.forEach((val, idx) => {
                        if (idx < colMaxLengths.length) {
                            const text = String(val || '').trim();
                            colMaxLengths[idx] = Math.max(colMaxLengths[idx], text.length);
                        }
                    });
                    // 收集样式和备注
                    const cellStylesMap = {};
                    for (let r = cellRefs.s.r; r <= cellRefs.e.r; r++) {
                        for (let c = cellRefs.s.c; c <= cellRefs.e.c; c++) {
                            const cellAddress = XLSX.utils.encode_cell({r, c});
                            const cell = sheet[cellAddress];
                            if (!cell) continue;
                            // 匹配背景色（黄色/粉色/红色）
                            let bgColor = '';
                            if (cell.s && cell.s.fill && cell.s.fill.fgColor && cell.s.fill.fgColor.rgb) {
                                const rgb = cell.s.fill.fgColor.rgb || cell.s.fill.fgColor.theme;
                                if (rgb && (rgb.includes('FFFF00') || rgb.includes('FFF200') || rgb === '6')) bgColor = 'yellow';
                                else if (rgb && (rgb.includes('F8BBD0') || rgb.includes('F8BBD9') || rgb === '4')) bgColor = 'pink';
                                else if (rgb && (rgb.includes('EF5350') || rgb.includes('FF0000') || rgb === '3')) bgColor = 'red';
                            }
                            // 提取备注 - 确保从XLSX文件中正确提取备注
                            let comment = '';
                            if (cell.c) {
                                // XLSX备注可能以对象形式存在，需要提取文本
                                comment = typeof cell.c === 'string' ? cell.c : (cell.c.t || '');
                            }
                            cellStylesMap[cellAddress] = { bgColor, comment };
                        }
                    }
                    // 设置列宽（保持原有宽度：A列123px、H-Z列146px）
                    colLetters.forEach((col, idx) => {
                        const th = getHeaderCell(col);
                        if (th) {
                            if (col === 'A') {
                                th.style.width = '123px';
                                th.style.minWidth = '123px';
                            } else if (col === 'C' || col === 'E') {
                                th.style.width = '70px';
                                th.style.minWidth = '70px';
                            } else if (col === 'D' || col === 'F') {
                                th.style.width = '40px';
                                th.style.minWidth = '40px';
                            } else if (col >= 'H' && col <= 'Z') {
                                th.style.width = '146px';
                                th.style.minWidth = '146px';
                            } else {
                                const contentLength = colMaxLengths[idx] || 0;
                                const calculatedWidth = Math.max(80, Math.min(300, contentLength * 8 + 20));
                                th.style.width = calculatedWidth + 'px';
                                th.style.minWidth = calculatedWidth + 'px';
                            }
                            th.style.height = '21px';
                        }
                    });
                    // 渲染行并绑定样式/备注
                    const rowsData = data.slice(1).map(row => ({ values: row, styles: cellStylesMap }));
                    rowsData.forEach((rowData, rowIndex) => {
                        const newRow = createNewRow(rowIndex + 1);
                        colLetters.forEach((col, colIndex) => {
                            const cell = newRow.querySelector(`[data-col="${col}"]`);
                            if (cell) {
                                const th = getHeaderCell(col);
                                if (th) {
                                    cell.style.width = th.style.width;
                                    cell.style.minWidth = th.style.minWidth;
                                }
                                const val = rowData.values[colIndex];
                                if (val !== undefined && val !== null) setCellText(cell, String(val).trim());
                                // 应用背景色
                                const cellAddress = XLSX.utils.encode_cell({r: rowIndex + 1, c: colIndex});
                                const cellStyle = rowData.styles[cellAddress] || {};
                                if (cellStyle.bgColor) setCellColor(cell, cellStyle.bgColor);
                                // 应用备注 - 仅添加红点指示器，移除has-comment类
                                if (cellStyle.comment && cellStyle.comment.trim() !== '') {
                                    cell.dataset.comment = cellStyle.comment.trim();
                                    // 添加备注指示器
                                    const indicator = document.createElement('div');
                                    indicator.className = 'comment-indicator';
                                    cell.appendChild(indicator);
                                }
                            }
                        });
                        tbody.appendChild(newRow);
                    });
                    originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
                    calculateDColumn();
                    checkDuplicateCells();
                    calcTargetHeader(CONFIG.calcHeaderCol);
                    saveToHistory();
                    saveToLocalStorageDelayed(); // 保存到本地存储
                    alert(`成功导入${data.length-1}行数据！列宽、背景色、备注已同步，并已保存到本地存储。`);
                } catch (err) {
                    alert('导入失败，请检查文件！');
                    console.error(err);
                }
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Excel导出 - 核心修改：移除showSaveFilePicker，改为纯浏览器下载，解决crdownload文件问题
        function saveToExcel() {
            try {
                // 收集表头
                const headerRow = ['#'];
                colLetters.forEach(col => {
                    headerRow.push(getCellText(getHeaderCell(col)) || col);
                });
                const rows = [headerRow];
                const cellStyles = {};
                const cellComments = {};
                // 收集数据行、样式、备注
                document.querySelectorAll('#dataTable tbody tr:not(.hidden)').forEach((row, rowIndex) => {
                    const rowData = [];
                    // 行号
                    const rowNumCell = row.querySelector('.row-header');
                    rowData.push(rowNumCell ? rowNumCell.textContent : '');
                    // 数据列
                    colLetters.forEach((col, colIndex) => {
                        const cell = row.querySelector(`[data-col="${col}"]`);
                        let text = getCellText(cell) || '';
                        const cellAddress = XLSX.utils.encode_cell({r: rowIndex + 1, c: colIndex + 1});
                        // 记录背景色样式
                        if (cell.classList.contains('cell-yellow')) {
                            cellStyles[cellAddress] = {
                                fill: { fgColor: { rgb: 'FFFF00' }, patternType: 'solid' }
                            };
                        } else if (cell.classList.contains('cell-pink')) {
                            cellStyles[cellAddress] = {
                                fill: { fgColor: { rgb: 'F8BBD0' }, patternType: 'solid' }
                            };
                        } else if (cell.classList.contains('cell-red') || cell.classList.contains('duplicate-cell')) {
                            cellStyles[cellAddress] = {
                                fill: { fgColor: { rgb: 'EF5350' }, patternType: 'solid' }
                            };
                        }
                        // 记录备注 - 从悬浮备注同步到XLSX
                        if (cell.dataset.comment) {
                            cellComments[cellAddress] = { t: cell.dataset.comment };
                        }
                        rowData.push(text);
                    });
                    rows.push(rowData);
                });
                // 生成Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                // 绑定样式和备注
                if (Object.keys(cellStyles).length > 0) {
                    ws['!styles'] = cellStyles;
                }
                if (Object.keys(cellComments).length > 0) {
                    ws['!comments'] = cellComments;
                }
                XLSX.utils.book_append_sheet(wb, ws, '药品数据');
                
                // 文件名规则不变：yb数据+年月日+空格时分（补0）
                const date = new Date();
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');
                const fileName = `yb数据${year}${month}${day} ${hour}${minute}.xlsx`;

                // 核心修改：纯浏览器下载，移除showSaveFilePicker，解决crdownload残留问题
                XLSX.writeFile(wb, fileName);
                alert(`保存成功！文件已开始下载：\n${fileName}\n可在浏览器下载栏找到文件`);
            } catch (err) {
                alert('保存失败！');
                console.error(err);
            }
        }

        // ==================== 本地存储功能 ====================
        
        // 保存数据到本地存储
        function saveToLocalStorage() {
            try {
                const data = {
                    headers: colLetters.map(col => getCellText(getHeaderCell(col))),
                    rows: Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => {
                        const rowData = {
                            cells: Array.from(row.querySelectorAll('td[data-col]')).map(td => ({
                                content: getCellText(td),
                                classes: Array.from(td.classList),
                                col: td.dataset.col,
                                comment: td.dataset.comment || '',
                                width: td.style.width
                            }))
                        };
                        return rowData;
                    }),
                    filterActive: isFilterActive,
                    colWidths: Array.from(document.querySelectorAll('#dataTable thead th:not(.row-header)')).map(th => th.style.width),
                    lastSaved: new Date().toISOString(),
                    version: '5.0'
                };
                
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
                console.log('数据已保存到本地存储:', new Date().toLocaleString());
                return true;
            } catch (err) {
                console.error('保存到本地存储失败:', err);
                return false;
            }
        }
        
        // 延迟保存到本地存储（防抖）- 核心修改：500ms → 5000ms（5秒）
        function saveToLocalStorageDelayed() {
            if (isInitializing) return;
            
            // 清除之前的计时器
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // 设置新的计时器，5000ms（5秒）后保存
            autoSaveTimer = setTimeout(() => {
                if (saveToLocalStorage()) {
                    showStorageStatus('数据已自动保存');
                }
            }, 5000); // 原500改为5000，实现5秒自动保存
        }
        
        // 从本地存储加载数据 - 保持原有宽度不变
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(CONFIG.storageKey);
                if (!savedData) {
                    console.log('本地存储中没有找到数据');
                    return false;
                }
                
                const data = JSON.parse(savedData);
                if (!data.rows || data.rows.length === 0) {
                    console.log('本地存储数据为空');
                    return false;
                }
                
                console.log('从本地存储加载数据，上次保存时间:', data.lastSaved ? new Date(data.lastSaved).toLocaleString() : '未知');
                
                const tbody = document.getElementById('tableTbody');
                tbody.innerHTML = '';
                
                // 恢复表头 - 保持原有宽度不变
                colLetters.forEach((col, idx) => {
                    const th = getHeaderCell(col);
                    if (th) {
                        // 保持原有宽度不变
                        if (col === 'A') {
                            th.style.width = '123px';
                            th.style.minWidth = '123px';
                        } else if (col === 'C' || col === 'E') {
                            th.style.width = '70px';
                            th.style.minWidth = '70px';
                        } else if (col === 'D' || col === 'F') {
                            th.style.width = '40px';
                            th.style.minWidth = '40px';
                        } else if (col >= 'H' && col <= 'Z') {
                            th.style.width = '146px';
                            th.style.minWidth = '146px';
                        } else {
                            th.style.width = data.colWidths && data.colWidths[idx] ? data.colWidths[idx] : '150px';
                        }
                        th.style.height = '21px';
                        if (data.headers && data.headers[idx] !== undefined) {
                            setCellText(th, data.headers[idx]);
                            th.querySelector('input').value = data.headers[idx];
                        }
                    }
                });
                
                // 恢复数据行 - 保持原有宽度不变
                data.rows.forEach((rowData, rowIndex) => {
                    const newRow = createNewRow(rowIndex + 1);
                    rowData.cells.forEach((cellData, idx) => {
                        const td = newRow.querySelector(`td[data-col="${cellData.col}"]`);
                        if (td) {
                            // 保持原有宽度不变
                            if (cellData.col === 'A') {
                                td.style.width = '123px';
                                td.style.minWidth = '123px';
                            } else if (cellData.col === 'C' || cellData.col === 'E') {
                                td.style.width = '70px';
                                td.style.minWidth = '70px';
                            } else if (cellData.col === 'D' || cellData.col === 'F') {
                                td.style.width = '40px';
                                td.style.minWidth = '40px';
                            } else if (cellData.col >= 'H' && cellData.col <= 'Z') {
                                td.style.width = '146px';
                                td.style.minWidth = '146px';
                            } else {
                                td.style.width = cellData.width || '150px';
                            }
                            td.style.height = '21px';
                            setCellText(td, cellData.content);
                            cellData.classes.forEach(cls => td.classList.add(cls));
                            if (cellData.comment) {
                                td.dataset.comment = cellData.comment;
                                // 仅添加红点指示器，移除has-comment类
                                const indicator = document.createElement('div');
                                indicator.className = 'comment-indicator';
                                td.appendChild(indicator);
                            }
                            if (CONFIG.readOnlyCol.includes(cellData.col)) {
                                td.classList.remove('editable');
                            } else {
                                td.classList.add('editable');
                            }
                        }
                    });
                    tbody.appendChild(newRow);
                });
                
                // 恢复筛选状态
                isFilterActive = data.filterActive || false;
                document.getElementById('filterToggle').classList.toggle('active', isFilterActive);
                
                // 如果保存时是筛选状态，重新应用筛选
                if (isFilterActive) {
                    toggleDColumnFilter();
                } else {
                    originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
                }
                
                // 重新绑定事件
                document.querySelectorAll('#dataTable td.editable').forEach(td => {
                    const input = td.querySelector('.cell-input');
                    if (input) {
                        bindCellEvents(td, input);
                    }
                });
                
                // 显示加载成功的提示
                setTimeout(() => {
                    showStorageStatus(`已加载${data.rows.length}行数据（${data.lastSaved ? new Date(data.lastSaved).toLocaleDateString() : '上次保存时间未知'}）`);
                }, 500);
                
                return true;
            } catch (err) {
                console.error('从本地存储加载数据失败:', err);
                return false;
            }
        }
        
        // 显示存储状态提示
        function showStorageStatus(message) {
            const statusEl = document.getElementById('storageStatus');
            statusEl.textContent = message;
            statusEl.classList.remove('show');
            // 触发重绘
            void statusEl.offsetWidth;
            statusEl.classList.add('show');
        }

        // ==================== 撤销/恢复功能 ====================
        
        // 保存到历史记录
        function saveToHistory() {
            if (isUndoRedo) return;
            redoStack = [];
            const data = {
                headers: colLetters.map(col => getCellText(getHeaderCell(col))),
                rows: Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => {
                    const rowData = {
                        rowNum: row.querySelector('.row-header')?.textContent || '',
                        cells: Array.from(row.querySelectorAll('td[data-col]')).map(td => ({
                            content: getCellText(td),
                            classes: Array.from(td.classList),
                            col: td.dataset.col,
                            comment: td.dataset.comment || '',
                            width: td.style.width
                        }))
                    };
                    return rowData;
                }),
                filterActive: isFilterActive,
                colWidths: Array.from(document.querySelectorAll('#dataTable thead th:not(.row-header)')).map(th => th.style.width)
            };
            historyStack.push(JSON.parse(JSON.stringify(data)));
            if (historyStack.length > 50) historyStack.shift();
            updateUndoRedoButtons();
        }
        
        function undo() {
            if (historyStack.length <= 1) return;
            isUndoRedo = true;
            redoStack.push(historyStack.pop());
            restoreTableState(historyStack[historyStack.length-1]);
            isUndoRedo = false;
            updateUndoRedoButtons();
            saveToLocalStorageDelayed(); // 保存到本地存储
        }
        
        function redo() {
            if (redoStack.length === 0) return;
            isUndoRedo = true;
            historyStack.push(redoStack.pop());
            restoreTableState(historyStack[historyStack.length-1]);
            isUndoRedo = false;
            updateUndoRedoButtons();
            saveToLocalStorageDelayed(); // 保存到本地存储
        }
        
        // 恢复表格状态 - 保持原有宽度不变
        function restoreTableState(state) {
            // 恢复表头 - 保持原有宽度不变
            colLetters.forEach((col, idx) => {
                const th = getHeaderCell(col);
                // 保持原有宽度不变
                if (col === 'A') {
                    th.style.width = '123px';
                    th.style.minWidth = '123px';
                } else if (col === 'C' || col === 'E') {
                    th.style.width = '70px';
                    th.style.minWidth = '70px';
                } else if (col === 'D' || col === 'F') {
                    th.style.width = '40px';
                    th.style.minWidth = '40px';
                } else if (col >= 'H' && col <= 'Z') {
                    th.style.width = '146px';
                    th.style.minWidth = '146px';
                } else {
                    th.style.width = state.colWidths[idx] || '150px';
                }
                th.style.height = '21px';
                setCellText(th, state.headers[idx]);
                th.querySelector('input').value = state.headers[idx];
            });
            // 恢复数据行 - 保持原有宽度不变
            const tbody = document.getElementById('tableTbody');
            tbody.innerHTML = '';
            state.rows.forEach((rowData, rowIndex) => {
                const row = createNewRow(rowIndex + 1);
                if (rowData.rowNum) {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = rowData.rowNum;
                }
                rowData.cells.forEach((cellData, idx) => {
                    const td = row.querySelector(`td[data-col="${cellData.col}"]`);
                    if (td) {
                        // 保持原有宽度不变
                        if (cellData.col === 'A') {
                            td.style.width = '123px';
                            td.style.minWidth = '123px';
                        } else if (cellData.col === 'C' || cellData.col === 'E') {
                            td.style.width = '70px';
                            td.style.minWidth = '70px';
                        } else if (cellData.col === 'D' || cellData.col === 'F') {
                            td.style.width = '40px';
                            td.style.minWidth = '40px';
                        } else if (cellData.col >= 'H' && cellData.col <= 'Z') {
                            td.style.width = '146px';
                            td.style.minWidth = '146px';
                        } else {
                            td.style.width = cellData.width || '150px';
                        }
                        td.style.height = '21px';
                        setCellText(td, cellData.content);
                        cellData.classes.forEach(cls => td.classList.add(cls));
                        if (cellData.comment) {
                            td.dataset.comment = cellData.comment;
                            // 仅添加红点指示器，移除has-comment类
                            const indicator = document.createElement('div');
                            indicator.className = 'comment-indicator';
                            td.appendChild(indicator);
                        }
                        if (CONFIG.readOnlyCol.includes(cellData.col)) {
                            td.classList.remove('editable');
                        } else {
                            td.classList.add('editable');
                        }
                    }
                });
                tbody.appendChild(row);
            });
            
            // 恢复筛选状态
            isFilterActive = state.filterActive;
            document.getElementById('filterToggle').classList.toggle('active', isFilterActive);
            
            // 如果恢复的是筛选状态，需要重新应用筛选
            if (isFilterActive) {
                toggleDColumnFilter();
            } else {
                originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            }
            
            // 重新绑定事件
            document.querySelectorAll('#dataTable td.editable').forEach(td => {
                const input = td.querySelector('.cell-input');
                if (input) {
                    bindCellEvents(td, input);
                }
            });
            
            calculateDColumn();
            checkDuplicateCells();
            updateUndoRedoButtons();
        }
        
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.classList.toggle('btn-disabled', historyStack.length <= 1);
            redoBtn.classList.toggle('btn-disabled', redoStack.length === 0);
        }
    </script>
</body>
</html>
