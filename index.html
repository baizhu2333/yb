<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>药品数据管理系统（表头自动计算）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        .container {
            max-width: 100%;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #bef264;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(217, 249, 157, 0.2);
            background-color: #fefee8;
        }
        .toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        #searchInput {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #d9f99d;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.3s;
        }
        #searchInput:focus {
            outline: none;
            border-color: #a3e635;
        }
        /* 按钮样式 */
        #filterToggle, #addRowBtn, #saveBtn, #undoBtn, #redoBtn, #importBtn {
            padding: 10px 20px;
            background-color: #a3e635;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 500;
        }
        #filterToggle:hover, #addRowBtn:hover, #saveBtn:hover, #undoBtn:hover, #redoBtn:hover, #importBtn:hover {
            background-color: #84cc16;
            transform: translateY(-1px);
        }
        #filterToggle:active, #addRowBtn:active, #saveBtn:active, #undoBtn:active, #redoBtn:active, #importBtn:active {
            transform: translateY(0);
        }
        #filterToggle.active {
            background-color: #84cc16;
        }
        .btn-disabled {
            background-color: #e9fbb8 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        #fileInput {
            display: none;
        }
        
        /* 右键菜单 */
        .context-menu {
            position: absolute;
            width: 200px;
            background: white;
            border: 1px solid #d9f99d;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(217, 249, 157, 0.2);
            z-index: 1000;
            display: none;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        .context-menu-item:hover {
            background-color: #f7fee7;
        }
        .context-menu-separator {
            height: 1px;
            background-color: #bef264;
            margin: 4px 0;
        }
        .menu-view-comment {
            color: #ef5350;
            font-weight: bold;
        }
        .menu-view-comment-text {
            color: #333;
            font-weight: normal;
            white-space: normal;
            word-break: break-word;
            max-height: 100px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 3px;
            margin-top: 5px;
            padding: 5px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        /* I列表头链接 */
        .header-link {
            color: #4d7c0f !important;
            cursor: pointer !important;
            text-decoration: underline !important;
        }
        .header-link:hover {
            color: #3f6212 !important;
            background-color: #f7fee7 !important;
        }
        
        /* 滚动容器 */
        .table-wrapper {
            max-height: 70vh;
            overflow: auto;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #a3e635 #f7fee7;
        }
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-wrapper::-webkit-scrollbar-track {
            background: #f7fee7;
            border-radius: 4px;
        }
        .table-wrapper::-webkit-scrollbar-thumb {
            background-color: #a3e635;
            border-radius: 4px;
        }
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: #84cc16;
        }

        .table-container {
            min-width: 100%;
            width: fit-content;
        }

        /* 表格核心样式 */
        table {
            width: fit-content;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            table-layout: fixed;
        }
        
        /* 行号列样式 */
        th.row-header {
            background-color: #e5f5d7 !important;
            color: #3f6212 !important;
            font-weight: bold;
            text-align: center;
            width: 40px !important;
            min-width: 40px !important;
            cursor: default;
            border-right: 2px solid #84cc16 !important;
            position: sticky;
            left: 0;
            z-index: 3;
        }
        
        td.row-header {
            background-color: #f0f9e8 !important;
            color: #4d7c0f !important;
            text-align: center;
            font-weight: bold;
            width: 40px !important;
            min-width: 40px !important;
            cursor: pointer;
            border-right: 2px solid #84cc16 !important;
            position: sticky;
            left: 0;
            z-index: 2;
        }
        
        th.row-header:hover, td.row-header:hover {
            background-color: #d9f99d !important;
        }
        
        th {
            border: 1px solid #bef264;
            padding: 4px 8px;
            text-align: left;
            min-width: 80px;
            overflow: hidden;
            background-color: #f7fee7;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
            line-height: 1.2;
            height: 36px;
            color: #4d7c0f;
            cursor: pointer;
        }
        /* Excel式列分隔线 */
        th::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 3px;
            height: 100%;
            cursor: col-resize;
            z-index: 5;
        }
        th:hover::after {
            background-color: #a3e635;
        }
        /* L表头特殊样式 */
        th[data-header="L"] {
            background-color: #f0f9e8;
        }
        td {
            border: 1px solid #bef264;
            padding: 4px 8px;
            text-align: left;
            min-width: 80px;
            overflow: hidden;
            resize: none;
            line-height: 1.2;
            height: 36px;
            cursor: text;
            position: relative;
            background-color: white;
            user-select: none;
        }

        /* 单元格内容 */
        .cell-content-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 可编辑单元格 */
        td.editable {
            outline: none;
            user-select: text;
        }
        td.editable:focus {
            background-color: #f7fee7;
            outline: 2px solid #a3e635;
        }
        /* 仅D列只读 */
        td:nth-child(5) { /* 现在第5列是D列，因为增加了行号列 */
            background-color: #fcfcec;
            color: #666;
            cursor: not-allowed;
            pointer-events: none;
        }
        /* 颜色标记 */
        .cell-yellow { background-color: #fff200 !important; color: #333 !important; }
        .cell-red { background-color: #ef5350 !important; color: white !important; }
        .cell-pink { background-color: #f8bbd9 !important; }
        /* 重复项标红 */
        .duplicate-cell {
            background-color: #ffebee !important;
            border: 1px solid #ef5350 !important;
        }
        /* 备注小红点 */
        .has-comment::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #ef5350;
            z-index: 1;
            pointer-events: none;
        }
        /* 表头编辑样式 */
        .header-cell {
            position: relative;
        }
        .header-cell input {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 4px 8px;
            border: 1px solid #a3e635;
            border-radius: 2px;
            outline: none;
            background: white;
            font-weight: bold;
            font-size: inherit;
            color: #4d7c0f;
        }
        .header-cell.editing input {
            display: block;
        }
        .header-cell span {
            display: block;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .header-cell.editing span {
            display: none;
        }
        
        /* 选中样式 - 像Excel一样 */
        .cell-selected {
            background-color: #e0f2fe !important;
            border: 1px solid #38bdf8 !important;
        }
        
        /* 行选中样式 */
        .row-selected td:not(.row-header) {
            background-color: #e0f2fe !important;
            border: 1px solid #38bdf8 !important;
        }
        
        /* 列选中样式 */
        .col-selected {
            background-color: #e0f2fe !important;
            border: 1px solid #38bdf8 !important;
        }
        
        /* 选中整行时行号的样式 */
        .row-selected td.row-header {
            background-color: #38bdf8 !important;
            color: white !important;
            border-right: 2px solid #0ea5e9 !important;
        }
        
        /* 选中整列时表头的样式 */
        .col-selected-header {
            background-color: #38bdf8 !important;
            color: white !important;
            border: 1px solid #0ea5e9 !important;
        }
        
        /* 搜索高亮 */
        .search-highlight {
            background-color: #fef08a !important;
            border: 1px solid #fbbf24 !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <input type="text" id="searchInput" placeholder="输入条码（≥8位）或药品名称，回车搜索...">
            <button id="filterToggle">筛选＞0</button>
            <button id="addRowBtn">新增药品</button>
            <button id="importBtn">导入Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xlsm">
            <button id="saveBtn">保存为Excel</button>
            <button id="undoBtn" class="btn-disabled">撤销 (Ctrl+Z)</button>
            <button id="redoBtn" class="btn-disabled">恢复 (Ctrl+Y)</button>
        </div>

        <div class="table-wrapper">
            <div class="table-container">
                <table id="dataTable">
                    <thead class="sticky-header">
                        <tr id="tableHeaderRow">
                            <!-- 第一列是行号列，然后A-Z列表头由JS自动生成 -->
                        </tr>
                    </thead>
                    <tbody id="tableTbody">
                        <!-- 数据行由JS初始化 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="cellContextMenu">
        <div class="context-menu-item menu-view-comment" data-action="view-comment">
            查看备注
            <div id="commentPreview" class="menu-view-comment-text"></div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="mark-red">标红</div>
        <div class="context-menu-item" data-action="mark-yellow">标黄</div>
        <div class="context-menu-item" data-action="mark-pink">标粉</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="add-comment">添加备注</div>
        <div class="context-menu-item" data-action="clear-comment">清除备注</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="clear-color">清除颜色</div>
    </div>

    <script>
        // 全局配置
        const CONFIG = {
            maxCol: 'Z', // 横向到Z列
            readOnlyCol: ['D'], // 仅D列只读（注意：现在D列是第5列，因为有行号列）
            calcHeaderCol: 'L', // 仅L表头有计算功能
            traceCodeCol: ['H','I','M','N'],
            countColForD: ['H','I','J','K','L','M','N']
        };
        // 全局变量
        let isFilterActive = false;
        let originalRows = [];
        let selectedCell = null;
        let selectedCells = new Set();
        let selectedRows = new Set();
        let selectedCols = new Set();
        let contextMenu = null;
        let historyStack = [];
        let redoStack = [];
        let isUndoRedo = false;
        let colLetters = [];
        // 列宽拖动变量
        let isResizing = false;
        let resizeTh = null;
        let startX = 0;
        let startWidth = 0;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            contextMenu = document.getElementById('cellContextMenu');
            colLetters = generateColLetters(CONFIG.maxCol);
            initTableHeader();
            initSampleData();
            initColResize();
            originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            saveToHistory();

            // 绑定所有事件
            initAllEvents();
            // 初始化L表头计算
            calcTargetHeader(CONFIG.calcHeaderCol);
            // 辅助功能初始化
            calculateDColumn();
            checkDuplicateCells();
            updateUndoRedoButtons();
        });

        // ========== 核心工具函数 ==========
        function generateColLetters(maxCol) {
            const letters = [];
            for (let i = 'A'.charCodeAt(0); i <= maxCol.charCodeAt(0); i++) {
                letters.push(String.fromCharCode(i));
            }
            return letters;
        }
        
        function getHeaderIndex(col) {
            return colLetters.indexOf(col);
        }
        
        // 获取表头单元格元素（注意：现在列索引+1，因为第一列是行号列）
        function getHeaderCell(col) {
            return document.querySelector(`th[data-header="${col}"]`);
        }
        
        function getCellText(cell) {
            const wrapper = cell.querySelector('.cell-content-wrapper');
            return wrapper ? wrapper.textContent.trim() : '';
        }
        
        function setCellText(cell, text) {
            const wrapper = cell.querySelector('.cell-content-wrapper');
            if (wrapper) wrapper.textContent = text;
            autoAdjustFontSize(cell);
        }
        
        function autoAdjustFontSize(cell) {
            const wrapper = cell.querySelector('.cell-content-wrapper');
            if (!wrapper || !getCellText(cell)) {
                wrapper.style.fontSize = '14px';
                return;
            }
            const temp = document.createElement('span');
            temp.style.cssText = 'position:absolute;visibility:hidden;white-space:nowrap;font-family:Microsoft YaHei;line-height:1.2;';
            temp.textContent = getCellText(cell);
            document.body.appendChild(temp);
            const cellWidth = cell.offsetWidth - 16;
            const cellHeight = cell.offsetHeight - 8;
            let min = 6, max = 20, best = 14;
            while (min <= max) {
                const mid = Math.floor((min + max) / 2);
                temp.style.fontSize = `${mid}px`;
                if (temp.offsetWidth <= cellWidth && temp.offsetHeight <= cellHeight) {
                    best = mid;
                    min = mid + 1;
                } else {
                    max = mid - 1;
                }
            }
            wrapper.style.fontSize = `${best}px`;
            document.body.removeChild(temp);
        }

        // ========== 核心功能：目标表头（L）自动计算 ==========
        function calcTargetHeader(targetCol) {
            const targetCell = getHeaderCell(targetCol);
            if (!targetCell) return;
            const targetIndex = getHeaderIndex(targetCol);
            const prev1Index = targetIndex - 1;
            const prev2Index = targetIndex - 2;
            
            if (prev2Index < 0 || prev1Index < 0) {
                setCellText(targetCell, '列数不足');
                targetCell.querySelector('input').value = '列数不足';
                return;
            }
            
            const prev2Col = colLetters[prev2Index];
            const prev1Col = colLetters[prev1Index];
            const prev2Val = parseFloat(getCellText(getHeaderCell(prev2Col))) || 0;
            const prev1Val = parseFloat(getCellText(getHeaderCell(prev1Col))) || 0;
            const result = (prev2Val - prev1Val).toFixed(1);
            
            setCellText(targetCell, result);
            targetCell.querySelector('input').value = result;
            calculateDColumn();
        }

        // ========== 表格初始化 ==========
        function initTableHeader() {
            const headerRow = document.getElementById('tableHeaderRow');
            
            // 添加行号列表头
            const rowNumHeader = document.createElement('th');
            rowNumHeader.className = 'row-header';
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '40px';
            headerRow.appendChild(rowNumHeader);
            
            // 添加A-Z列表头
            const headerText = {
                A: '条码', B: '药品名称', C: '价', D: '无', E: 'h', F: '备注',
                H: 'Q02000000', I: '点击访问网站', J: '240', K: '126.8', L: '计算值'
            };
            
            colLetters.forEach(col => {
                const th = document.createElement('th');
                th.className = 'header-cell';
                th.dataset.header = col;
                th.style.width = '80px';
                if (col === 'I') th.classList.add('header-link');
                if (col === CONFIG.calcHeaderCol) th.style.backgroundColor = '#f0f9e8';
                const text = headerText[col] || '';
                th.innerHTML = `
                    <div class="cell-content-wrapper"><span>${text}</span></div>
                    <input type="text" value="${text}" data-header="${col}">
                `;
                headerRow.appendChild(th);
                autoAdjustFontSize(th);
                
                // 添加表头点击事件选择整列
                th.addEventListener('click', function(e) {
                    if (e.target.tagName === 'INPUT') return; // 避免编辑时触发选择
                    selectColumn(col);
                });
            });
        }

        function initSampleData() {
            const tbody = document.getElementById('tableTbody');
            // 示例行1
            const row1 = createNewRow(1);
            setCellText(row1.querySelector('[data-col="A"]'), '6934114761936');
            setCellText(row1.querySelector('[data-col="B"]'), 'bt生脉饮党参方盾克康福');
            setCellText(row1.querySelector('[data-col="C"]'), '62');
            setCellText(row1.querySelector('[data-col="E"]'), '35');
            setCellText(row1.querySelector('[data-col="F"]'), 'bt');
            setCellText(row1.querySelector('[data-col="H"]'), '84680850001502374758');
            setCellText(row1.querySelector('[data-col="J"]'), '240');
            setCellText(row1.querySelector('[data-col="K"]'), '126.8');
            setCellText(row1.querySelector('[data-col="L"]'), '113.2');
            // 亮黄色标记
            row1.querySelector('[data-col="B"]').classList.add('cell-yellow');
            row1.querySelector('[data-col="C"]').classList.add('cell-yellow');
            tbody.appendChild(row1);
            // 示例行2
            const row2 = createNewRow(2);
            setCellText(row2.querySelector('[data-col="A"]'), '6975782860026');
            setCellText(row2.querySelector('[data-col="B"]'), 'ybx橡一活络油医用退热凝胶湖北5');
            setCellText(row2.querySelector('[data-col="C"]'), '59');
            setCellText(row2.querySelector('[data-col="E"]'), '50');
            setCellText(row2.querySelector('[data-col="H"]'), '0');
            tbody.appendChild(row2);
        }

        // 创建新行（带行号）
        function createNewRow(rowNum) {
            const tr = document.createElement('tr');
            
            // 添加行号单元格
            const rowNumCell = document.createElement('td');
            rowNumCell.className = 'row-header';
            rowNumCell.textContent = rowNum;
            rowNumCell.style.width = '40px';
            tr.appendChild(rowNumCell);
            
            // 添加行号单元格点击事件
            rowNumCell.addEventListener('click', function(e) {
                selectRow(tr);
            });
            
            // 添加数据列
            colLetters.forEach(col => {
                const td = document.createElement('td');
                td.dataset.col = col;
                td.style.width = '80px';
                td.innerHTML = '<div class="cell-content-wrapper"></div>';
                if (CONFIG.readOnlyCol.includes(col)) {
                    td.contentEditable = false;
                    setCellText(td, '0');
                } else {
                    td.classList.add('editable');
                    td.contentEditable = true;
                    if (CONFIG.traceCodeCol.includes(col)) td.classList.add('trace-code');
                }
                bindCellEvents(td);
                autoAdjustFontSize(td);
                tr.appendChild(td);
            });
            return tr;
        }

        // ========== 行和列选择功能 ==========
        // 选择整行
        function selectRow(row) {
            clearAllSelections();
            
            row.classList.add('row-selected');
            selectedRows.add(row);
            
            const cells = row.querySelectorAll('td:not(.row-header)');
            cells.forEach(cell => {
                selectedCells.add(cell);
            });
            
            const firstEditable = row.querySelector('td.editable');
            if (firstEditable) {
                selectedCell = firstEditable;
                selectedCell.style.outline = '2px solid #a3e635';
            }
        }
        
        // 选择整列
        function selectColumn(col) {
            clearAllSelections();
            
            const colIndex = getHeaderIndex(col) + 2; // +2 因为第一列是行号列，nth-child从1开始
            
            // 标记表头
            const header = getHeaderCell(col);
            if (header) header.classList.add('col-selected-header');
            selectedCols.add(col);
            
            // 选择该列所有单元格（不包括行号列）
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const cell = row.querySelector(`td:nth-child(${colIndex})`);
                if (cell) {
                    cell.classList.add('col-selected');
                    selectedCells.add(cell);
                }
            });
            
            // 设置主选中单元格为该列第一个可编辑单元格
            const firstRow = document.querySelector('#dataTable tbody tr:first-child');
            if (firstRow) {
                const firstCell = firstRow.querySelector(`td:nth-child(${colIndex})`);
                if (firstCell) {
                    selectedCell = firstCell;
                    selectedCell.style.outline = '2px solid #a3e635';
                }
            }
        }
        
        // 清除所有选择
        function clearAllSelections() {
            // 清除单元格选择
            selectedCells.clear();
            document.querySelectorAll('.cell-selected, .col-selected').forEach(cell => {
                cell.classList.remove('cell-selected', 'col-selected');
            });
            
            // 清除行选择
            selectedRows.clear();
            document.querySelectorAll('.row-selected').forEach(row => {
                row.classList.remove('row-selected');
            });
            
            // 清除列选择
            selectedCols.clear();
            document.querySelectorAll('.col-selected-header').forEach(header => {
                header.classList.remove('col-selected-header');
            });
            
            // 清除主选中单元格样式
            if (selectedCell) {
                selectedCell.style.outline = '';
                if (selectedCell.classList.contains('editable')) selectedCell.blur();
            }
        }

        // ========== 列宽拖动 ==========
        function initColResize() {
            document.querySelectorAll('#dataTable thead th:not(.row-header)').forEach(th => {
                th.addEventListener('mousedown', function(e) {
                    if (e.clientX - this.getBoundingClientRect().right > -3) {
                        isResizing = true;
                        resizeTh = this;
                        startX = e.clientX;
                        startWidth = this.offsetWidth;
                        document.body.style.cursor = 'col-resize';
                        e.preventDefault();
                    }
                });
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !resizeTh) return;
                const newWidth = Math.max(50, startWidth + (e.clientX - startX));
                resizeTh.style.width = `${newWidth}px`;
                resizeTh.style.minWidth = `${newWidth}px`;
                
                const colIndex = Array.from(resizeTh.parentElement.children).indexOf(resizeTh);
                document.querySelectorAll(`#dataTable tbody td:nth-child(${colIndex + 1})`).forEach(td => {
                    td.style.width = `${newWidth}px`;
                    td.style.minWidth = `${newWidth}px`;
                    autoAdjustFontSize(td);
                });
                
                autoAdjustFontSize(resizeTh);
            });
            
            document.addEventListener('mouseup', () => endResize());
            document.addEventListener('mouseleave', () => endResize());
            
            function endResize() {
                if (isResizing) {
                    isResizing = false;
                    resizeTh = null;
                    document.body.style.cursor = 'default';
                    !isUndoRedo && saveToHistory();
                }
            }
        }

        // ========== 所有事件绑定 ==========
        function initAllEvents() {
            initSearchInput();
            initButtonEvents();
            initHeaderEditEvent();
            initCellBaseEvents();
            initContextMenuEvent();
            initKeyboardShortcut();
            initIHeaderLink();
        }

        function initSearchInput() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); performSearch(); }
            });
            searchInput.addEventListener('input', () => {
                if (!searchInput.value.trim()) {
                    document.querySelectorAll('#dataTable tbody tr').forEach(row => row.classList.remove('hidden'));
                    saveToHistory();
                }
            });
        }

        function initButtonEvents() {
            document.getElementById('filterToggle').addEventListener('click', function() {
                isFilterActive = !isFilterActive;
                toggleDColumnFilter();
                this.classList.toggle('active', isFilterActive);
            });
            
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            document.getElementById('fileInput').addEventListener('change', handleExcelImport);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('saveBtn').addEventListener('click', saveToExcel);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
        }

        function initHeaderEditEvent() {
            document.querySelectorAll('.header-cell:not(.header-link)').forEach(cell => {
                const input = cell.querySelector('input');
                
                cell.addEventListener('click', function(e) {
                    // 防止点击表头时触发列选择
                    if (e.target === cell || e.target === cell.querySelector('span')) {
                        cell.classList.add('editing');
                        input.value = getCellText(cell);
                        input.focus();
                        e.stopPropagation();
                    }
                });
                
                const finishEdit = () => {
                    cell.classList.remove('editing');
                    if (getCellText(cell) !== input.value) {
                        setCellText(cell, input.value);
                        autoAdjustFontSize(cell);
                        calcTargetHeader(CONFIG.calcHeaderCol);
                        !isUndoRedo && saveToHistory();
                    }
                };
                
                input.addEventListener('blur', finishEdit);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') { e.preventDefault(); finishEdit(); }
                });
            });
        }

        function initCellBaseEvents() {
            document.querySelectorAll('#dataTable td:not(.row-header)').forEach(cell => {
                cell.addEventListener('click', e => { 
                    if (!e.shiftKey && !e.ctrlKey) {
                        selectCell(cell); 
                        e.stopPropagation(); 
                    }
                });
                cell.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    selectCell(cell);
                    updateContextMenu();
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                });
                autoAdjustFontSize(cell);
            });
        }

        function updateContextMenu() {
            const commentPreview = document.getElementById('commentPreview');
            
            if (selectedCells.size > 0) {
                let allComments = [];
                selectedCells.forEach(cell => {
                    if (cell.dataset.comment) {
                        allComments.push(cell.dataset.comment);
                    }
                });
                
                if (allComments.length > 0) {
                    commentPreview.innerHTML = allComments.join('<br>---<br>');
                    commentPreview.style.display = 'block';
                } else {
                    commentPreview.innerHTML = '无备注';
                    commentPreview.style.display = 'block';
                }
            } else if (selectedCell && selectedCell.tagName === 'TD') {
                const comment = selectedCell.dataset.comment;
                commentPreview.innerHTML = comment || '无备注';
                commentPreview.style.display = 'block';
            } else {
                commentPreview.innerHTML = '';
                commentPreview.style.display = 'none';
            }
        }

        function initContextMenuEvent() {
            contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (!selectedCell && selectedCells.size === 0) return;
                    
                    const action = this.dataset.action;
                    
                    if (action === 'view-comment') {
                        showCommentDialog();
                        contextMenu.style.display = 'none';
                        return;
                    }
                    
                    // 获取所有需要操作的单元格
                    let cellsToProcess = [];
                    
                    if (selectedRows.size > 0) {
                        selectedRows.forEach(row => {
                            Array.from(row.querySelectorAll('td:not(.row-header)')).forEach(cell => {
                                if (cell.classList.contains('editable')) {
                                    cellsToProcess.push(cell);
                                }
                            });
                        });
                    }
                    else if (selectedCols.size > 0) {
                        const colIndices = Array.from(selectedCols).map(col => getHeaderIndex(col) + 2);
                        document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                            colIndices.forEach(colIndex => {
                                const cell = row.querySelector(`td:nth-child(${colIndex})`);
                                if (cell && cell.classList.contains('editable')) {
                                    cellsToProcess.push(cell);
                                }
                            });
                        });
                    }
                    else if (selectedCells.size > 0) {
                        cellsToProcess = Array.from(selectedCells);
                    }
                    else if (selectedCell) {
                        cellsToProcess = [selectedCell];
                    }
                    
                    cellsToProcess.forEach(cell => {
                        if (!cell || cell.tagName !== 'TD') return;
                        
                        switch(action) {
                            case 'mark-red': setCellColor(cell, 'red'); break;
                            case 'mark-yellow': setCellColor(cell, 'yellow'); break;
                            case 'mark-pink': setCellColor(cell, 'pink'); break;
                            case 'add-comment': addCellComment(cell); break;
                            case 'clear-comment': clearCellComment(cell); break;
                            case 'clear-color': setCellColor(cell, 'clear'); break;
                        }
                    });
                    
                    if (['mark-red','mark-yellow','mark-pink','clear-color','add-comment','clear-comment'].includes(action)) {
                        !isUndoRedo && saveToHistory();
                    }
                    contextMenu.style.display = 'none';
                });
            });
            
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
        }

        function showCommentDialog() {
            let comments = [];
            
            const cellsToCheck = selectedCells.size > 0 ? 
                Array.from(selectedCells) : 
                (selectedCell ? [selectedCell] : []);
            
            cellsToCheck.forEach(cell => {
                if (cell && cell.dataset.comment) {
                    const row = cell.parentElement;
                    const rowNum = row.querySelector('.row-header').textContent;
                    comments.push(`第${rowNum}行 ${cell.dataset.col}列: ${cell.dataset.comment}`);
                }
            });
            
            const commentText = comments.length > 0 ? comments.join('\n\n') : '无备注信息';
            const popup = window.open('', '_blank', 'width=500,height=300,top=200,left=400');
            popup.document.write(`
                <html><body style="padding:20px;font-family:Microsoft YaHei;">
                <h3 style="color:#ef5350;margin-bottom:10px;">单元格备注</h3>
                <div style="font-size:14px;line-height:1.5;white-space:pre-line;background:#f9f9f9;padding:15px;border-radius:5px;border:1px solid #ddd;max-height:200px;overflow-y:auto;">
                    ${commentText.replace(/\n/g, '<br>')}
                </div>
                <button onclick="window.close()" style="margin-top:15px;padding:8px 20px;background:#a3e635;border:none;border-radius:4px;cursor:pointer;">
                    关闭
                </button>
                </body></html>
            `);
            popup.document.close();
        }

        // ========== I列表头跳转链接（改进版）==========
        function initIHeaderLink() {
            const iHeader = document.querySelector('.header-link');
            iHeader.addEventListener('click', function(e) {
                e.preventDefault();
                const baseUrl = 'https://www.mashangfangxin.com/';
                
                // 优先使用当前选中的文本
                let searchText = '';
                const selection = window.getSelection();
                if (selection && selection.toString().trim()) {
                    searchText = selection.toString().trim();
                }
                
                // 如果没有选中文本，提示用户输入
                if (!searchText) {
                    searchText = prompt('请输入搜索内容（将自动填充到网站搜索框）：', '');
                    if (searchText === null) return;
                }
                
                // 打开带搜索参数的页面
                if (searchText) {
                    const encodedText = encodeURIComponent(searchText);
                    window.open(`${baseUrl}?search=${encodedText}`, '_blank');
                } else {
                    window.open(baseUrl, '_blank');
                }
            });
        }

        // ========== 键盘快捷键 ==========
        function initKeyboardShortcut() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    e.key === 'z' && (e.preventDefault(), undo());
                    e.key === 'y' && (e.preventDefault(), redo());
                }
                
                if (selectedCell && selectedCell.tagName === 'TD' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                    const row = selectedCell.parentElement;
                    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr:not(.hidden)'));
                    const currentRowIndex = rows.indexOf(row);
                    const cells = Array.from(row.querySelectorAll('td:not(.row-header)'));
                    const currentCellIndex = cells.indexOf(selectedCell);
                    switch(e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            if (currentRowIndex > 0) {
                                const targetCell = rows[currentRowIndex-1].querySelectorAll('td:not(.row-header)')[currentCellIndex];
                                targetCell && selectCell(targetCell);
                            }
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            if (currentRowIndex < rows.length-1) {
                                const targetCell = rows[currentRowIndex+1].querySelectorAll('td:not(.row-header)')[currentCellIndex];
                                targetCell && selectCell(targetCell);
                            }
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            currentCellIndex > 0 && selectCell(cells[currentCellIndex-1]);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            currentCellIndex < cells.length-1 && selectCell(cells[currentCellIndex+1]);
                            break;
                    }
                }
            });
        }

        // ========== 单元格事件 ==========
        function bindCellEvents(td) {
            td.addEventListener('click', e => { 
                if (!e.shiftKey && !e.ctrlKey) {
                    selectCell(td); 
                    e.stopPropagation(); 
                }
            });
            
            td.addEventListener('contextmenu', e => {
                e.preventDefault();
                selectCell(td);
                updateContextMenu();
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
            });
            
            if (!td.classList.contains('editable')) return;
            
            let prevValue = getCellText(td);
            
            td.addEventListener('input', () => autoAdjustFontSize(td));
            
            td.addEventListener('blur', () => {
                const currVal = getCellText(td);
                if (currVal !== prevValue && !isUndoRedo) {
                    prevValue = currVal;
                    saveToHistory();
                }
                checkDuplicateCells();
                calculateDColumn();
            });
            
            td.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const currVal = getCellText(td);
                    if (currVal !== prevValue && !isUndoRedo) {
                        prevValue = currVal;
                        saveToHistory();
                    }
                    checkDuplicateCells();
                    calculateDColumn();
                    handleEnterKeyMove(td);
                }
            });
        }

        function handleEnterKeyMove(cell) {
            const row = cell.parentElement;
            const rows = Array.from(document.querySelectorAll('#dataTable tbody tr:not(.hidden)'));
            const currentRowIdx = rows.indexOf(row);
            const cells = Array.from(row.querySelectorAll('td.editable'));
            const currentCellIdx = cells.indexOf(cell);

            if (currentCellIdx < cells.length - 1) {
                selectCell(cells[currentCellIdx + 1]);
                return;
            }
            if (currentRowIdx < rows.length - 1) {
                const nextFirst = rows[currentRowIdx + 1].querySelector('td.editable');
                nextFirst && selectCell(nextFirst);
                return;
            }
            selectCell(cell);
        }

        // ========== 业务功能 ==========
        function selectCell(cell) {
            clearAllSelections();
            
            selectedCell = cell;
            if (cell.tagName === 'TD') {
                cell.style.outline = '2px solid #a3e635';
                cell.classList.add('cell-selected');
                selectedCells.add(cell);
                if (cell.classList.contains('editable')) cell.focus();
            }
        }

        function addNewRow() {
            const tbody = document.getElementById('tableTbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = createNewRow(rowCount + 1);
            tbody.appendChild(newRow);
            originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            selectCell(newRow.querySelector('td.editable'));
            calculateDColumn();
            checkDuplicateCells();
            !isUndoRedo && saveToHistory();
        }

        function toggleDColumnFilter() {
            const tbody = document.getElementById('tableTbody');
            tbody.innerHTML = '';
            if (isFilterActive) {
                const filtered = originalRows.filter(row => {
                    const dCell = row.querySelector('td[data-col="D"]');
                    const dVal = parseFloat(getCellText(dCell)) || 0;
                    return dVal > 0;
                }).sort((a, b) => {
                    const aCell = a.querySelector('td[data-col="C"]');
                    const bCell = b.querySelector('td[data-col="C"]');
                    const aVal = parseFloat(getCellText(aCell)) || 0;
                    const bVal = parseFloat(getCellText(bCell)) || 0;
                    return bVal - aVal;
                });
                
                // 重新编号行号
                filtered.forEach((row, index) => {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = index + 1;
                    tbody.appendChild(row);
                });
            } else {
                originalRows.forEach((row, index) => {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = index + 1;
                    row.classList.remove('hidden');
                    tbody.appendChild(row);
                });
            }
            !isUndoRedo && saveToHistory();
        }

        function calculateDColumn() {
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const dCell = row.querySelector('[data-col="D"]');
                if (!dCell) return;
                let count = 0;
                CONFIG.countColForD.forEach(col => {
                    const cell = row.querySelector(`[data-col="${col}"]`);
                    if (getCellText(cell) !== '') count++;
                });
                setCellText(dCell, count.toString());
            });
        }

        function checkDuplicateCells() {
            const excludeCols = ['C','D','E','F','G'];
            const valueMap = new Map();
            
            document.querySelectorAll('#dataTable tbody td[data-col]').forEach(cell => {
                const col = cell.dataset.col;
                const text = getCellText(cell).trim();
                if (excludeCols.includes(col) || !text || text === '0' || parseFloat(text) === 0) return;
                if (!valueMap.has(text)) valueMap.set(text, []);
                valueMap.get(text).push(cell);
            });
            
            document.querySelectorAll('.duplicate-cell').forEach(cell => cell.classList.remove('duplicate-cell'));
            
            valueMap.forEach((cells, val) => {
                if (cells.length > 1) cells.forEach(cell => cell.classList.add('duplicate-cell'));
            });
        }

        function addCellComment(cell) {
            clearCellComment(cell);
            const comment = prompt('请输入备注：', cell.dataset.comment || '');
            if (comment === null || comment.trim() === '') return;
            cell.dataset.comment = comment.trim();
            cell.classList.add('has-comment');
        }
        
        function clearCellComment(cell) {
            delete cell.dataset.comment;
            cell.classList.remove('has-comment');
        }

        function setCellColor(cell, color) {
            cell.classList.remove('cell-red', 'cell-yellow', 'cell-pink');
            if (color !== 'clear') cell.classList.add(`cell-${color}`);
            const wrapper = cell.querySelector('.cell-content-wrapper');
            wrapper.style.color = color === 'red' ? 'white' : '#333';
        }

        // ========== Excel导入导出 ==========
        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file || !['xlsx','xlsm'].includes(file.name.split('.').pop().toLowerCase())) {
                alert('仅支持.xlsx/.xlsm格式！');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    if (data.length <= 1) { alert('无有效数据！'); return; }
                    
                    const tbody = document.getElementById('tableTbody');
                    tbody.innerHTML = '';
                    
                    for (let i = 1; i < data.length; i++) {
                        const rowData = data[i];
                        const newRow = createNewRow(i);
                        rowData.forEach((val, idx) => {
                            const col = colLetters[idx];
                            if (!col) return;
                            const cell = newRow.querySelector(`[data-col="${col}"]`);
                            cell && setCellText(cell, val || '');
                        });
                        tbody.appendChild(newRow);
                    }
                    
                    originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
                    calculateDColumn();
                    checkDuplicateCells();
                    calcTargetHeader(CONFIG.calcHeaderCol);
                    saveToHistory();
                    
                    alert(`成功导入${data.length-1}行数据！`);
                } catch (err) {
                    alert('导入失败，请检查文件！');
                    console.error(err);
                }
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function saveToExcel() {
            try {
                // 收集表头（不包括行号列表头）
                const headerRow = ['#'];
                colLetters.forEach(col => {
                    headerRow.push(getCellText(getHeaderCell(col)) || col);
                });
                
                const rows = [headerRow];
                
                // 收集数据行
                document.querySelectorAll('#dataTable tbody tr:not(.hidden)').forEach(row => {
                    const rowData = [];
                    // 行号
                    const rowNumCell = row.querySelector('.row-header');
                    rowData.push(rowNumCell ? rowNumCell.textContent : '');
                    
                    // 数据列
                    colLetters.forEach(col => {
                        const cell = row.querySelector(`[data-col="${col}"]`);
                        let text = getCellText(cell) || '';
                        if (cell && cell.dataset.comment) text += `【备注：${cell.dataset.comment}】`;
                        rowData.push(text);
                    });
                    rows.push(rowData);
                });
                
                // 生成Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, '药品数据');
                const date = new Date();
                const fileName = `药品数据_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,0)}${date.getDate().toString().padStart(2,0)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                alert(`保存成功：${fileName}`);
            } catch (err) {
                alert('保存失败！');
                console.error(err);
            }
        }

        // ========== 撤销/恢复功能 ==========
        function saveToHistory() {
            if (isUndoRedo) return;
            redoStack = [];
            const data = {
                headers: colLetters.map(col => getCellText(getHeaderCell(col))),
                rows: Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => {
                    const rowData = {
                        rowNum: row.querySelector('.row-header')?.textContent || '',
                        cells: Array.from(row.querySelectorAll('td[data-col]')).map(td => ({
                            content: getCellText(td),
                            classes: Array.from(td.classList),
                            col: td.dataset.col,
                            comment: td.dataset.comment || '',
                            width: td.style.width
                        }))
                    };
                    return rowData;
                }),
                filterActive: isFilterActive,
                colWidths: Array.from(document.querySelectorAll('#dataTable thead th:not(.row-header)')).map(th => th.style.width)
            };
            historyStack.push(JSON.parse(JSON.stringify(data)));
            if (historyStack.length > 50) historyStack.shift();
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyStack.length <= 1) return;
            isUndoRedo = true;
            redoStack.push(historyStack.pop());
            restoreTableState(historyStack[historyStack.length-1]);
            isUndoRedo = false;
            updateUndoRedoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            isUndoRedo = true;
            historyStack.push(redoStack.pop());
            restoreTableState(historyStack[historyStack.length-1]);
            isUndoRedo = false;
            updateUndoRedoButtons();
        }

        function restoreTableState(state) {
            // 恢复表头
            colLetters.forEach((col, idx) => {
                const th = getHeaderCell(col);
                th.style.width = state.colWidths[idx] || '80px';
                setCellText(th, state.headers[idx]);
                th.querySelector('input').value = state.headers[idx];
                autoAdjustFontSize(th);
            });
            
            // 恢复数据行
            const tbody = document.getElementById('tableTbody');
            tbody.innerHTML = '';
            
            state.rows.forEach((rowData, rowIndex) => {
                const row = createNewRow(rowIndex + 1);
                if (rowData.rowNum) {
                    const rowNumCell = row.querySelector('.row-header');
                    if (rowNumCell) rowNumCell.textContent = rowData.rowNum;
                }
                
                rowData.cells.forEach((cellData, idx) => {
                    const td = row.querySelector(`td[data-col="${cellData.col}"]`);
                    if (td) {
                        td.style.width = cellData.width || '80px';
                        setCellText(td, cellData.content);
                        
                        cellData.classes.forEach(cls => td.classList.add(cls));
                        if (cellData.comment) {
                            td.dataset.comment = cellData.comment;
                            td.classList.add('has-comment');
                        }
                        
                        if (CONFIG.readOnlyCol.includes(cellData.col)) {
                            td.contentEditable = false;
                        } else {
                            td.classList.add('editable');
                            td.contentEditable = true;
                        }
                        
                        bindCellEvents(td);
                        autoAdjustFontSize(td);
                    }
                });
                
                tbody.appendChild(row);
            });
            
            isFilterActive = state.filterActive;
            document.getElementById('filterToggle').classList.toggle('active', isFilterActive);
            originalRows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
            
            calculateDColumn();
            checkDuplicateCells();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.classList.toggle('btn-disabled', historyStack.length <= 1);
            redoBtn.classList.toggle('btn-disabled', redoStack.length === 0);
        }

        function performSearch() {
            const term = document.getElementById('searchInput').value.trim();
            if (!term) return;
            const isBarcode = term.length >= 8 && /^[A-Za-z0-9]+$/.test(term);
            let firstVisible = null;
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const aText = getCellText(row.querySelector('[data-col="A"]'));
                const bText = getCellText(row.querySelector('[data-col="B"]'));
                const match = isBarcode ? aText === term : bText.includes(term);
                if (match) {
                    row.classList.remove('hidden');
                    firstVisible = firstVisible || row;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            if (firstVisible) {
                const hCell = firstVisible.querySelector('[data-col="H"]');
                hCell && selectCell(hCell);
            }
            !isUndoRedo && saveToHistory();
        }
    </script>
</body>
</html>