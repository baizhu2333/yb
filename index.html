<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩËçØÂìÅÊï∞ÊçÆÁÆ°ÁêÜÁ≥ªÁªü</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 15.44px;
        }

        /* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .ribbon {
            background: #fff;
            border-bottom: 1px solid #d4d4d4;
            padding: 9.5px 14.26px;
            display: flex;
            gap: 14.26px;
            align-items: center;
            box-shadow: 0 2.38px 4.75px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .ribbon-group {
            display: flex;
            gap: 7.13px;
            padding-right: 14.26px;
            border-right: 1px solid #e0e0e0;
            align-items: center;
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .btn {
            padding: 7.13px 16.63px;
            border: 1px solid #d4d4d4;
            background: #fff;
            border-radius: 4.75px;
            cursor: pointer;
            font-size: 15.44px;
            display: flex;
            align-items: center;
            gap: 7.13px;
            transition: all 0.2s;
            color: #333;
            height: 38px;
        }

        .btn:hover {
            background: #f0f0f0;
            border-color: #b4b4b4;
        }

        .btn-primary {
            background: #217346;
            color: white;
            border-color: #217346;
        }

        .btn-primary:hover {
            background: #1e623d;
        }

        .btn-warning {
            background: #ff6b6b;
            color: white;
            border-color: #ff5252;
        }

        .btn-warning:hover {
            background: #ff5252;
        }

        .btn-active {
            background: #84cc16 !important;
            color: white !important;
            border-color: #65a30d !important;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #searchInput {
            width: 356px;
            padding: 0 14.26px;
            border: 1px solid #d4d4d4;
            border-radius: 4.75px;
            font-size: 15.44px;
            height: 38px;
            line-height: 38px;
        }

        #searchInput:focus {
            outline: none;
            border-color: #217346;
            box-shadow: 0 0 0 3.56px rgba(33, 115, 70, 0.1);
        }

        /* Ë°®Ê†ºÂÆπÂô® */
        .spreadsheet-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #fff;
            transform-origin: top left;
        }

        /* ExcelÈ£éÊ†ºË°®Ê†º */
        .sheet-table {
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
            user-select: none;
            font-size: 15.44px;
        }

        .sheet-table th,
        .sheet-table td {
            border: 1px solid #d4d4d4;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        /* Ë°åÂàóÂè∑Ê†∑Âºè */
        .sheet-table th {
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            text-align: center;
            position: sticky;
            z-index: 10;
            font-size: 15.56px;
        }

        .sheet-table th.corner {
            background: #f0f0f0;
            z-index: 20;
            top: 0;
            left: 0;
            width: 43.2px;
            min-width: 43.2px;
        }

        .sheet-table th.col-header {
            top: 0;
            min-width: 95.04px;
            height: 28.51px;
            line-height: 28.51px;
            font-size: 15.56px;
            border-bottom: 2px solid #c0c0c0;
            background: #e5f5d7;
            color: #3f6212;
        }

        /* Â∫èÂè∑Âàó */
        .sheet-table th.row-header {
            left: 0;
            width: 43.2px;
            min-width: 43.2px;
            height: 28.51px;
            line-height: 28.51px;
            font-size: 15.56px;
            border-right: 2px solid #c0c0c0;
            cursor: pointer;
            background: #f0f9e8;
            color: #4d7c0f;
            text-align: left;
            padding-left: 4.32px;
        }

        .sheet-table th.row-header:hover {
            background: #dcfce7;
        }

        /* ÂçïÂÖÉÊ†ºÊ†∑Âºè */
        .sheet-table td {
            width: 95.04px;
            min-width: 95.04px;
            height: 28.51px;
            background: #fff;
            cursor: cell;
        }

        .cell-content {
            width: 100%;
            height: 100%;
            padding: 2.38px 4.75px;
            font-size: 15.44px;
            line-height: 23.76px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            outline: none;
            border: 2px solid transparent;
            position: relative;
        }

        .cell-content.selected {
            border: 2px solid #217346;
            background: #e8f5e9;
        }

        .cell-content.editing {
            background: #fff;
            border: 2px solid #217346;
            z-index: 100;
            position: relative;
            cursor: text;
            user-select: text;
            white-space: pre;
            overflow: auto;
        }

        /* ÁâπÊÆäÂàóÊ†∑Âºè - C„ÄÅEÂÆΩÂ∫¶60pxÔºåD„ÄÅFÂÆΩÂ∫¶44px */
        td[data-col="D"], th[data-col="D"],
        td[data-col="F"], th[data-col="F"] {
            width: 47.52px !important;
            min-width: 47.52px !important;
            max-width: 47.52px !important;
        }

        td[data-col="C"], th[data-col="C"],
        td[data-col="E"], th[data-col="E"] {
            width: 64.8px !important;
            min-width: 64.8px !important;
            max-width: 64.8px !important;
        }

        /* ÈöêËóèÂõ∫ÂÆöÂàóÁöÑË∞ÉÊï¥ÊâãÊüÑ */
        th[data-col="D"] .col-resize-handle,
        th[data-col="C"] .col-resize-handle,
        th[data-col="E"] .col-resize-handle,
        th[data-col="F"] .col-resize-handle {
            display: none !important;
        }

        td[data-col="D"] {
            background: #fcfcec !important;
            cursor: not-allowed !important;
        }

        td.meta-col {
            background: #f9f9f9 !important;
            font-size: 11.88px !important;
            color: #666 !important;
            width: 71.28px !important;
            min-width: 71.28px !important;
        }

        th.meta-col {
            background: #e0e0e0 !important;
            color: #666 !important;
            font-size: 12.96px !important;
            width: 71.28px !important;
            min-width: 71.28px !important;
        }

        /* ÂèØÁºñËæëÊ†áÈ¢ò */
        th.col-header.editable-header {
            cursor: text;
            background: #f0f9e8;
        }

        th.col-header.editable-header:hover {
            background: #dcfce7;
        }

        th.col-header .header-text {
            pointer-events: none;
        }

        th.col-header.editable-header .header-text {
            pointer-events: auto;
        }

        /* IÂàóÈìæÊé•Ê†∑Âºè */
        th[data-col="I"] {
            color: #1976d2 !important;
            text-decoration: underline !important;
            cursor: pointer !important;
        }

        th[data-col="I"]:hover {
            background: #e3f2fd !important;
        }

        /* Ê†áËÆ∞È¢úËâ≤ */
        .cell-yellow { background-color: #fff200 !important; }
        .cell-red { background-color: #ef5350 !important; color: white !important; }
        .cell-pink { background-color: #f8bbd9 !important; }
        .duplicate-cell { background-color: #ef5350 !important; color: white !important; }
        .search-highlight { background-color: #fef08a !important; }

        /* Ë°åÈ´ò‰∫ÆÊïàÊûú - Ê∑°ËìùËâ≤ËÉåÊôØ */
        tr.row-highlight td {
            background-color: #e3f2fd !important;
        }

        /* ÊúâÈ¢úËâ≤ÁöÑÂçïÂÖÉÊ†ºË∑≥ËøáÈ´ò‰∫Æ */
        tr.row-highlight td.cell-yellow,
        tr.row-highlight td.cell-red,
        tr.row-highlight td.cell-pink,
        tr.row-highlight td.duplicate-cell,
        tr.row-highlight td.search-highlight {
            background-color: inherit !important;
        }

        /* Â∫èÂè∑ÂàóÈ´ò‰∫Æ */
        th.row-header.row-highlight {
            background-color: #e3f2fd !important;
        }

        /* Â§áÊ≥®ÊåáÁ§∫Âô® - ÊîæÂ§ß */
        .comment-indicator {
            position: absolute;
            top: 1.08px;
            right: 1.08px;
            width: 10.8px;
            height: 10.8px;
            background-color: #ef5350;
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
        }

        /* ÂàóÂÆΩË∞ÉÊï¥ÊâãÊüÑ */
        .col-resize-handle {
            position: absolute;
            top: 2.38px;
            right: 2.38px;
            width: 14.26px;
            height: 14.26px;
            border-radius: 3.56px;
            background-color: #a3e635;
            cursor: col-resize;
            z-index: 5;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .col-resize-handle:hover {
            opacity: 1;
            background-color: #84cc16;
        }

        /* Âè≥ÈîÆËèúÂçï */
        .context-menu {
            position: absolute;
            width: 261.36px;
            background: white;
            border: 1px solid #d4d4d4;
            box-shadow: 0 4.75px 14.26px rgba(0,0,0,0.15);
            border-radius: 4.75px;
            padding: 4.75px 0;
            z-index: 10000;
            display: none;
        }

        .context-menu-item {
            padding: 9.5px 19.01px;
            cursor: pointer;
            font-size: 15.44px;
            display: flex;
            align-items: center;
            gap: 9.5px;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        /* Ê†áÁ≤âËèúÂçïÈ°πÁâπÊÆäÊ†∑Âºè */
        .context-menu-item.pink-item::before {
            content: '';
            display: inline-block;
            width: 17.28px;
            height: 17.28px;
            background-color: #f8bbd9;
            border-radius: 3.89px;
            margin-right: 4.32px;
        }

        .context-menu-separator {
            height: 1px;
            background-color: #e0e0e0;
            margin: 4.75px 0;
        }

        /* Â§áÊ≥®ÂºπÁ™ó */
        .comment-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffe1;
            border: 2px solid #999;
            border-radius: 9.5px;
            padding: 23.76px;
            font-size: 16.63px;
            min-width: 356px;
            max-width: 594px;
            box-shadow: 0 9.5px 28.51px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            word-wrap: break-word;
            line-height: 1.6;
            color: #333;
        }

        .comment-popup.show {
            display: block;
            animation: popIn 0.3s;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .comment-popup-close {
            position: absolute;
            top: 9.5px;
            right: 14.26px;
            cursor: pointer;
            font-size: 23.76px;
            color: #666;
        }

        .comment-popup-close:hover {
            color: #000;
        }

        /* ÊÇ¨ÂÅúÂ§áÊ≥®ÊèêÁ§∫ */
        .comment-tooltip {
            position: fixed;
            background: rgba(51, 51, 51, 0.95);
            color: white;
            padding: 8.64px 12.96px;
            border-radius: 4.32px;
            font-size: 14px;
            max-width: 324px;
            word-wrap: break-word;
            z-index: 10002;
            display: none;
            pointer-events: none;
            box-shadow: 0 2.16px 8.64px rgba(0,0,0,0.2);
        }

        .comment-tooltip.show {
            display: block;
        }

        /* ÊãñÊãΩÈÄâÊã©Ê°Ü */
        .selection-box {
            position: absolute;
            background-color: rgba(56, 189, 248, 0.1);
            border: 2px solid #38bdf8;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        /* Âä†ËΩΩÈÅÆÁΩ© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 23.76px;
        }

        .loading-spinner {
            width: 59.4px;
            height: 59.4px;
            border: 5.94px solid #f3f3f3;
            border-top: 5.94px solid #217346;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 356px;
            height: 23.76px;
            background: #e0e0e0;
            border-radius: 11.88px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #217346;
            width: 0%;
            transition: width 0.3s;
        }

        /* ToastÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(51, 51, 51, 0.95);
            color: white;
            padding: 19.01px 38.02px;
            border-radius: 9.5px;
            font-size: 16.63px;
            z-index: 10001;
            display: none;
            box-shadow: 0 4.75px 14.26px rgba(0,0,0,0.3);
        }

        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* ÈÅÆÁΩ©Â±Ç */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
        }

        .modal-overlay.show {
            display: block;
        }

        /* ÈöêËóèË°åÊ†∑Âºè */
        tr.hidden-row {
            display: none !important;
        }

        /* ÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 14.26px;
            height: 14.26px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #c1c1c1;
            border-radius: 7.13px;
            border: 3.56px solid #f1f1f1;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #a1a1a1;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Âä†ËΩΩÈÅÆÁΩ© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div id="loadingText">Ê≠£Âú®Â§ÑÁêÜ...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- ToastÊèêÁ§∫ -->
    <div class="toast" id="toast"></div>

    <!-- ÊÇ¨ÂÅúÂ§áÊ≥®ÊèêÁ§∫ -->
    <div class="comment-tooltip" id="commentTooltip"></div>

    <!-- ÈÅÆÁΩ©Â±Ç -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="ribbon">
        <div class="ribbon-group">
            <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Êù°Á†ÅÊàñËçØÂìÅÂêçÁß∞(A/BÂàó)...">
            <button class="btn" id="clearSearchBtn">Ê∏ÖÁ©∫ÊêúÁ¥¢</button>
            <button class="btn" id="filterToggle">Á≠õÈÄâÔºû0</button>
        </div>

        <div class="ribbon-group">
            <label class="btn btn-primary">
                <span>üìÇ ÊâìÂºÄ</span>
                <input type="file" id="fileInput" accept=".xlsx,.xlsm" style="display: none;">
            </label>
            <button class="btn btn-warning" id="saveBtn">üíæ ‰øùÂ≠ò</button>
        </div>

        <div class="ribbon-group">
            <button class="btn" id="addRowBtn">‚ûï Êñ∞Â¢ûË°å</button>
            <button class="btn" id="undoBtn" disabled>‚Ü©Ô∏è Êí§ÈîÄ(Ctrl+Z)</button>
            <button class="btn" id="redoBtn" disabled>‚Ü™Ô∏è ÊÅ¢Â§ç(Ctrl+Y)</button>
        </div>

        <div style="flex: 1;"></div>
    </div>

    <!-- Ë°®Ê†ºÂå∫Âüü -->
    <div class="spreadsheet-container" id="container">
        <table class="sheet-table" id="sheetTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="selection-box" id="selectionBox"></div>
    </div>

    <!-- Âè≥ÈîÆËèúÂçï -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="addComment()">üìù Ê∑ªÂä†/ÁºñËæëÂ§áÊ≥®</div>
        <div class="context-menu-item" onclick="clearComment()">üóëÔ∏è Ê∏ÖÈô§Â§áÊ≥®</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="formatCell('red')">üü• Á∫¢Ëâ≤ÔºàÊúâÈóÆÈ¢òÔºâ</div>
        <div class="context-menu-item" onclick="formatCell('yellow')">üü® Ê†áÈªÑÔºàË°•ËçØÔºâ</div>
        <div class="context-menu-item pink-item" onclick="formatCell('pink')">Ê†áÁ≤âÔºàÂ¶áÁßëÔºâ</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="clearCellFormat()">‚¨ú Ê∏ÖÈô§È¢úËâ≤</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteSelectedRow()">üóëÔ∏è Âà†Èô§Êï¥Ë°å</div>
        <div class="context-menu-item" onclick="clearSelectedCells()">‚å´ Ê∏ÖÁ©∫ÂÜÖÂÆπ</div>
    </div>

    <!-- Â§áÊ≥®ÂºπÁ™ó -->
    <div class="comment-popup" id="commentPopup">
        <span class="comment-popup-close" onclick="closeCommentPopup()">√ó</span>
        <div id="commentPopupContent"></div>
    </div>

    <script>
        // ==================== ÈÖçÁΩÆ ====================
        const CONFIG = {
            maxCol: 'AN',
            dataMaxCol: 'T',
            readOnlyCol: ['D'],
            calcHeaderCol: 'L',
            editableHeaders: ['H', 'I', 'J', 'K'],
            formulaHeaders: ['J', 'K'],
            traceCodeCol: ['H','I','M','N'],
            countColForD: [],
            noMetaCols: ['C', 'D', 'E', 'F', 'G'],
            noResizeCols: ['C', 'D', 'E', 'F'],
            storageKey: 'medicine_excel_data_v2_3',
            metaDataSeparator: '|',
            batchSize: 50,
            maxHistory: 20,
            debounceDelay: 300,
            importChunkSize: 100
        };

        for(let i='H'.charCodeAt(0); i<='T'.charCodeAt(0); i++) {
            CONFIG.countColForD.push(String.fromCharCode(i));
        }

        // ==================== Áä∂ÊÄÅÁÆ°ÁêÜ ====================
        const state = {
            rows: 100,
            cols: 40,
            data: {},
            headerData: {},
            selectedCell: null,
            selectedCells: new Set(),
            editingCell: null,
            isFilterActive: false,
            searchTerm: '',
            filteredRows: new Set(),
            originalData: [],
            historyStack: [],
            redoStack: [],
            isUndoRedo: false,
            isProcessing: false,
            colLetters: [],
            dragStartCell: null,
            isDragging: false,
            lastClickTime: 0,
            lastRightClickTime: 0,
            activeInput: null,
            editingHeader: null,
            highlightedRow: null
        };

        function generateColLetters() {
            const letters = [];
            for (let i = 0; i < 26; i++) letters.push(String.fromCharCode(65 + i));
            for (let i = 0; i < 14; i++) letters.push('A' + String.fromCharCode(65 + i));
            return letters;
        }

        // ==================== ÂàùÂßãÂåñ ====================
        document.addEventListener('DOMContentLoaded', () => {
            state.colLetters = generateColLetters();
            initTable();
            initEvents();
            initSampleData();
            loadFromLocalStorage();
            saveToHistory();
        });

        // ==================== Ë°®Ê†ºÂàùÂßãÂåñ ====================
        function initTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            const headerText = {
                A: 'Êù°Á†Å', B: 'ËçØÂìÅÂêçÁß∞', C: '‰ª∑', D: 'Êó†Á©∫', E: 'hyj', F: '‰∏äÈôê', G: 'Â§áÊ≥®',
                H: 'Q02000000', I: 'ÁÇπÂáªËÆøÈóÆÁΩëÁ´ô', J: '240', K: '126.8', L: 'ËÆ°ÁÆóÂÄº',
                M: '', N: '', O: '', P: '', Q: '', R: '', S: '', T: '',
                U: 'AÂÖÉ', V: 'BÂÖÉ', W: 'CÂÖÉ', X: 'DÂÖÉ', Y: 'EÂÖÉ', Z: 'FÂÖÉ',
                AA: 'GÂÖÉ', AB: 'HÂÖÉ', AC: 'IÂÖÉ', AD: 'JÂÖÉ', AE: 'KÂÖÉ', AF: 'LÂÖÉ',
                AG: 'MÂÖÉ', AH: 'NÂÖÉ', AI: 'OÂÖÉ', AJ: 'PÂÖÉ', AK: 'QÂÖÉ', AL: 'RÂÖÉ',
                AM: 'SÂÖÉ', AN: 'TÂÖÉ'
            };

            state.colLetters.forEach(col => {
                state.headerData[col] = headerText[col] || col;
            });

            let headerHTML = '<tr><th class="corner"></th>';
            state.colLetters.forEach((col, idx) => {
                const isMeta = idx >= 20;
                const isD = col === 'D';
                const isEditable = CONFIG.editableHeaders.includes(col);
                const isI = col === 'I';
                const text = state.headerData[col];
                const noResize = CONFIG.noResizeCols.includes(col);
                
                let width = getColWidth(col, idx);
                
                const classes = ['col-header'];
                if (isMeta) classes.push('meta-col');
                if (isEditable || isI) classes.push('editable-header');
                
                const clickHandler = isI ? 'onclick="openWebsite()"' : 
                                   (isEditable ? 'onclick="editHeader(\'' + col + '\')"' : '');
                
                headerHTML += `<th class="${classes.join(' ')}" data-col="${col}" style="width: ${width}px; min-width: ${width}px; ${noResize ? 'max-width: ' + width + 'px;' : ''}" ${clickHandler}>
                    <span class="header-text">${text}</span>
                    ${(!isMeta && !noResize) ? '<div class="col-resize-handle" onmousedown="startColResize(event, \'' + col + '\')"></div>' : ''}
                </th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            renderEmptyRows();
            calculateLHeader();
        }

        function getColWidth(col, idx) {
            if (col === 'A') return 145.8;
            if (col === 'C' || col === 'E') return 64.8;
            if (col === 'D' || col === 'F') return 47.52;
            if (idx >= 7 && idx <= 19) return 173.88;
            if (idx >= 20) return 71.28;
            return 118.8;
        }

        function renderEmptyRows() {
            const tbody = document.getElementById('tableBody');
            let bodyHTML = '';
            for (let r = 0; r < state.rows; r++) {
                bodyHTML += `<tr data-row-num="${r + 1}"><th class="row-header" onclick="selectRow(${r})">${r + 1}</th>`;
                state.colLetters.forEach((col, idx) => {
                    const isMeta = idx >= 20;
                    const isReadOnly = CONFIG.readOnlyCol.includes(col);
                    const cellId = `${col}${r + 1}`;
                    const width = getColWidth(col, idx);
                    const noResize = CONFIG.noResizeCols.includes(col);
                    
                    bodyHTML += `
                        <td data-row="${r}" data-col="${col}" data-id="${cellId}" 
                            class="${isMeta ? 'meta-col' : ''} ${isReadOnly ? '' : 'editable'}"
                            style="width: ${width}px; min-width: ${width}px; ${noResize ? 'max-width: ' + width + 'px;' : ''}"
                            onclick="handleCellClick(event, '${cellId}')"
                            onmouseenter="highlightRow(${r}); showCommentTooltip(event, '${cellId}')"
                            onmouseleave="clearHighlight(); hideCommentTooltip()">
                            <div class="cell-content" id="cell-${cellId}"></div>
                        </td>
                    `;
                });
                bodyHTML += '</tr>';
            }
            tbody.innerHTML = bodyHTML;
        }

        // ==================== È´ò‰∫ÆË°å ====================
        function highlightRow(rowIdx) {
            clearHighlight();
            state.highlightedRow = rowIdx;
            
            const row = document.querySelectorAll('#tableBody tr')[rowIdx];
            if (!row || row.classList.contains('hidden-row')) return;
            
            row.classList.add('row-highlight');
            
            const rowHeader = row.querySelector('.row-header');
            if (rowHeader) rowHeader.classList.add('row-highlight');
        }

        function clearHighlight() {
            document.querySelectorAll('.row-highlight').forEach(el => {
                el.classList.remove('row-highlight');
            });
            state.highlightedRow = null;
        }

        // ==================== Ê†áÈ¢òÁºñËæë ====================
        function editHeader(col) {
            if (state.editingHeader) return;
            
            const th = document.querySelector(`th[data-col="${col}"]`);
            const currentText = state.headerData[col];
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.cssText = 'width: 100%; height: 100%; border: none; outline: 2px solid #217346; padding: 2px; font-size: 14px; font-weight: bold; text-align: center;';
            
            const span = th.querySelector('.header-text');
            span.style.display = 'none';
            th.appendChild(input);
            input.focus();
            input.select();
            
            state.editingHeader = col;
            
            const finishEdit = () => {
                const newValue = input.value.trim();
                if (newValue && newValue !== currentText) {
                    state.headerData[col] = newValue;
                    span.textContent = newValue;
                    
                    if (CONFIG.formulaHeaders.includes(col)) {
                        calculateLHeader();
                    }
                    
                    saveToHistory();
                }
                input.remove();
                span.style.display = '';
                state.editingHeader = null;
            };
            
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEdit();
                } else if (e.key === 'Escape') {
                    input.remove();
                    span.style.display = '';
                    state.editingHeader = null;
                }
            });
        }

        function calculateLHeader() {
            const jVal = parseFloat(state.headerData['J']) || 0;
            const kVal = parseFloat(state.headerData['K']) || 0;
            const lVal = (jVal - kVal).toFixed(1);
            state.headerData['L'] = lVal;
            
            const thL = document.querySelector(`th[data-col="L"] .header-text`);
            if (thL) thL.textContent = lVal;
        }

        function openWebsite() {
            window.open('https://www.mashangfangxin.com/', '_blank', 'noopener,noreferrer');
        }

        // ==================== ‰∫ã‰ª∂Â§ÑÁêÜ ====================
        function initEvents() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                    jumpToSearchResult();
                }
            });
            
            document.getElementById('tableBody').addEventListener('dblclick', (e) => {
                const td = e.target.closest('td[data-col]');
                if (!td) return;
                
                const cellId = td.dataset.id;
                const col = cellId.match(/[A-Z]+/)[0];
                
                if (CONFIG.readOnlyCol.includes(col) || isMetaCol(col)) return;
                
                e.preventDefault();
                selectCell(cellId);
                startEdit(cellId, e);
            });
            
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
            document.getElementById('filterToggle').addEventListener('click', toggleFilter);
            
            document.getElementById('fileInput').addEventListener('change', handleExcelImport);
            document.getElementById('saveBtn').addEventListener('click', saveToExcel);
            
            document.getElementById('addRowBtn').addEventListener('click', handleAddRowClick);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            
            document.addEventListener('keydown', handleGlobalKeydown);
            
            initDragSelection();
            
            document.addEventListener('contextmenu', handleGlobalRightClick);
            
            document.addEventListener('mousedown', (e) => {
                const menu = document.getElementById('contextMenu');
                if (menu.style.display === 'block' && !e.target.closest('.context-menu')) {
                    menu.style.display = 'none';
                }
            });

            window.addEventListener('beforeunload', saveToLocalStorage);
        }

        // ==================== Êñ∞Â¢ûË°åÊåâÈíÆÂ§ÑÁêÜ ====================
        function handleAddRowClick() {
            const container = document.getElementById('container');
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            const scrollTop = container.scrollTop;
            
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
            
            if (!isAtBottom) {
                container.scrollTop = scrollHeight;
            } else {
                addNewRow();
            }
        }

        // ==================== ÊÇ¨ÂÅúÂ§áÊ≥®ÊèêÁ§∫ ====================
        function showCommentTooltip(e, cellId) {
            const cell = document.getElementById(`cell-${cellId}`);
            const comment = cell.dataset.comment;
            
            if (comment) {
                const tooltip = document.getElementById('commentTooltip');
                tooltip.textContent = comment;
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY + 10) + 'px';
                tooltip.classList.add('show');
            }
        }

        function hideCommentTooltip() {
            const tooltip = document.getElementById('commentTooltip');
            tooltip.classList.remove('show');
        }

        // ==================== Âè≥ÈîÆÂèåÂáªÂ§ÑÁêÜ ====================
        function handleGlobalRightClick(e) {
            const cell = e.target.closest('td[data-col]');
            if (!cell) return;
            
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - state.lastRightClickTime;
            
            if (timeDiff < 300) {
                e.preventDefault();
                e.stopPropagation();
                
                const cellId = cell.dataset.id;
                selectCell(cellId);
                showContextMenu(e, cellId);
                
                state.lastRightClickTime = 0;
            } else {
                state.lastRightClickTime = currentTime;
            }
        }

        // ==================== ÊêúÁ¥¢Á≠õÈÄâ ====================
        function performSearch() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            state.searchTerm = term;
            
            if (!term) {
                clearSearch();
                return;
            }
            
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });
            
            state.filteredRows.clear();
            
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.remove('hidden-row');
            });
            
            for (let r = 1; r <= state.rows; r++) {
                const aVal = (state.data[`A${r}`] || '').toLowerCase();
                const bVal = (state.data[`B${r}`] || '').toLowerCase();
                
                const row = document.querySelector(`tr[data-row-num="${r}"]`);
                
                if (aVal.includes(term) || bVal.includes(term)) {
                    state.filteredRows.add(r);
                    if (aVal.includes(term)) {
                        const cellA = document.getElementById(`cell-A${r}`);
                        if (cellA) cellA.classList.add('search-highlight');
                    }
                    if (bVal.includes(term)) {
                        const cellB = document.getElementById(`cell-B${r}`);
                        if (cellB) cellB.classList.add('search-highlight');
                    }
                } else {
                    row.classList.add('hidden-row');
                }
            }
            
            showToast(`ÊâæÂà∞ ${state.filteredRows.size} ‰∏™ÂåπÈÖçÈ°π`);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            state.searchTerm = '';
            state.filteredRows.clear();
            
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });
            
            if (state.isFilterActive) {
                applyFilter();
            } else {
                document.querySelectorAll('#tableBody tr').forEach(tr => {
                    tr.classList.remove('hidden-row');
                });
            }
        }

        function toggleFilter() {
            state.isFilterActive = !state.isFilterActive;
            const btn = document.getElementById('filterToggle');
            btn.classList.toggle('btn-active', state.isFilterActive);
            
            if (state.isFilterActive) {
                btn.textContent = 'ÊòæÁ§∫ÂÖ®ÈÉ®';
                applyFilter();
            } else {
                btn.textContent = 'Á≠õÈÄâÔºû0';
                clearFilter();
            }
            
            saveToHistory();
        }

        function applyFilter() {
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.remove('hidden-row');
            });
            
            let visibleCount = 0;
            
            for (let r = 1; r <= state.rows; r++) {
                const dVal = parseInt(state.data[`D${r}`] || '0');
                const row = document.querySelector(`tr[data-row-num="${r}"]`);
                
                if (dVal <= 0) {
                    row.classList.add('hidden-row');
                } else {
                    visibleCount++;
                }
            }
            
            showToast(`Á≠õÈÄâÊòæÁ§∫ ${visibleCount} Ë°å`);
        }

        function clearFilter() {
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.remove('hidden-row');
            });
            
            if (state.searchTerm) {
                performSearch();
            }
        }

        function jumpToSearchResult() {
            if (!state.searchTerm || state.filteredRows.size === 0) return;
            
            const firstMatchRow = Math.min(...Array.from(state.filteredRows));
            const hCellId = `H${firstMatchRow}`;
            
            const hCell = document.getElementById(`cell-${hCellId}`);
            if (!hCell) return;
            
            const hValue = hCell.textContent.trim();
            
            if (hValue === '') {
                if (!hCell.closest('tr').classList.contains('hidden-row')) {
                    selectCell(hCellId);
                    hCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            for (let i = 1; i < CONFIG.countColForD.length; i++) {
                const col = CONFIG.countColForD[i];
                const cellId = `${col}${firstMatchRow}`;
                const cell = document.getElementById(`cell-${cellId}`);
                
                if (!cell) continue;
                
                const value = cell.textContent.trim();
                
                if (value === '') {
                    if (!cell.closest('tr').classList.contains('hidden-row')) {
                        selectCell(cellId);
                        cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
            }
        }

        // ==================== ÂçïÂÖÉÊ†ºÊìç‰Ωú ====================
        function handleCellClick(e, cellId) {
            e.stopPropagation();
            
            const cell = document.getElementById(`cell-${cellId}`);
            const td = cell.parentElement;
            
            if (e.ctrlKey) {
                toggleCellSelection(td);
            } else if (e.shiftKey && state.selectedCell) {
                selectCellRange(state.selectedCell, cellId);
            } else {
                selectCell(cellId);
                
                if (td.classList.contains('editable') && !td.classList.contains('meta-col')) {
                    startEdit(cellId, e);
                }
            }
        }

        function selectCell(cellId) {
            document.querySelectorAll('.cell-content.selected').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('tr.row-selected').forEach(tr => {
                tr.classList.remove('row-selected');
            });
            state.selectedCells.clear();
            
            state.selectedCell = cellId;
            const cell = document.getElementById(`cell-${cellId}`);
            if (cell) {
                cell.classList.add('selected');
                cell.focus();
            }
        }

        function selectRow(rowIdx) {
            clearAllSelections();
            const row = document.querySelectorAll('#tableBody tr')[rowIdx];
            if (row.classList.contains('hidden-row')) return;
            
            row.classList.add('row-selected');
            
            const editableCells = row.querySelectorAll('td.editable');
            editableCells.forEach(cell => {
                state.selectedCells.add(cell.dataset.id);
                cell.querySelector('.cell-content').classList.add('selected');
            });
            
            if (editableCells.length > 0) {
                selectCell(editableCells[0].dataset.id);
            }
        }

        function toggleCellSelection(td) {
            const cellId = td.dataset.id;
            const cell = td.querySelector('.cell-content');
            
            if (state.selectedCells.has(cellId)) {
                state.selectedCells.delete(cellId);
                cell.classList.remove('selected');
            } else {
                state.selectedCells.add(cellId);
                cell.classList.add('selected');
                state.selectedCell = cellId;
            }
        }

        function selectCellRange(startId, endId) {
            clearAllSelections();
            selectCell(endId);
        }

        function clearAllSelections() {
            document.querySelectorAll('.cell-content.selected').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('tr.row-selected').forEach(tr => {
                tr.classList.remove('row-selected');
            });
            state.selectedCells.clear();
        }

        // ==================== ÁºñËæëÂäüËÉΩÔºàÂê´ÂèåÂáªÂÖ®ÈÄâÔºâ ====================
        function startEdit(cellId, clickEvent) {
            if (state.editingCell) endEdit();
            
            if (state.isFilterActive || state.searchTerm) {
                const actualRow = getActualRowNumber(cellId);
                if (actualRow) {
                    cellId = cellId.replace(/\d+$/, actualRow);
                }
            }
            
            state.editingCell = cellId;
            const cell = document.getElementById(`cell-${cellId}`);
            
            const currentContent = cell.innerHTML;
            const hasIndicator = cell.querySelector('.comment-indicator');
            
            cell.contentEditable = true;
            cell.classList.add('editing');
            cell.focus();
            
            if (clickEvent && clickEvent.type === 'dblclick') {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(cell);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            if (hasIndicator) {
                cell.innerHTML = currentContent;
            }
            
            if (clickEvent && clickEvent.type !== 'dblclick') {
                const range = document.caretRangeFromPoint(clickEvent.clientX, clickEvent.clientY);
                if (range) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            state.activeInput = cell;
        }

        function endEdit() {
            if (!state.editingCell) return;
            
            const cellId = state.editingCell;
            const cell = document.getElementById(`cell-${cellId}`);
            
            const indicator = cell.querySelector('.comment-indicator');
            if (indicator) indicator.remove();
            
            const value = cell.textContent;
            const oldValue = state.data[cellId] || '';
            
            if (cell.dataset.comment) {
                if (!cell.querySelector('.comment-indicator')) {
                    const newIndicator = document.createElement('div');
                    newIndicator.className = 'comment-indicator';
                    cell.appendChild(newIndicator);
                }
            }
            
            if (value !== oldValue) {
                setCellData(cellId, value);
                
                const col = cellId.match(/[A-Z]+/)[0];
                if (isDataCol(col) && !CONFIG.noMetaCols.includes(col)) {
                    syncMetaData(cellId);
                }
                
                calculateDColumn();
                checkDuplicates();
                saveToHistory();
            }
            
            cell.contentEditable = false;
            cell.classList.remove('editing');
            state.editingCell = null;
            state.activeInput = null;
        }

        function setCellData(cellId, value) {
            state.data[cellId] = value;
            const cell = document.getElementById(`cell-${cellId}`);
            if (cell) {
                const indicator = cell.querySelector('.comment-indicator');
                cell.textContent = value;
                if (indicator) {
                    cell.appendChild(indicator);
                }
            }
        }

        function moveToNextCell() {
            if (!state.selectedCell) return;
            
            const match = state.selectedCell.match(/([A-Z]+)(\d+)/);
            const col = match[1];
            const row = parseInt(match[2]);
            
            const colIndex = state.colLetters.indexOf(col);
            let nextColIndex = colIndex + 1;
            
            while (nextColIndex < state.colLetters.length) {
                const nextCol = state.colLetters[nextColIndex];
                if (!CONFIG.readOnlyCol.includes(nextCol) && !isMetaCol(nextCol)) {
                    const nextCellId = `${nextCol}${row}`;
                    const nextCell = document.getElementById(`cell-${nextCellId}`);
                    if (nextCell && !nextCell.closest('tr').classList.contains('hidden-row')) {
                        selectCell(nextCellId);
                        startEdit(nextCellId);
                        return;
                    }
                }
                nextColIndex++;
            }
            
            const nextRow = row + 1;
            if (nextRow <= state.rows) {
                for (let i = 0; i < state.colLetters.length; i++) {
                    const c = state.colLetters[i];
                    if (!CONFIG.readOnlyCol.includes(c) && !isMetaCol(c)) {
                        const nextCellId = `${c}${nextRow}`;
                        const nextCell = document.getElementById(`cell-${nextCellId}`);
                        if (nextCell && !nextCell.closest('tr').classList.contains('hidden-row')) {
                            selectCell(nextCellId);
                            startEdit(nextCellId);
                            return;
                        }
                    }
                }
            }
        }

        // ==================== Ê†∏ÂøÉÂäüËÉΩ ====================
        function isDataCol(col) {
            return col >= 'A' && col <= 'T';
        }

        function isMetaCol(col) {
            const idx = state.colLetters.indexOf(col);
            return idx >= 20;
        }

        function getMetaCol(dataCol) {
            const index = dataCol.charCodeAt(0) - 'A'.charCodeAt(0);
            const metaIndex = index + 20;
            if (metaIndex < 26) {
                return String.fromCharCode(65 + metaIndex);
            } else {
                return 'A' + String.fromCharCode(65 + (metaIndex - 26));
            }
        }

        function getActualRowNumber(cellId) {
            const displayRow = parseInt(cellId.match(/\d+/)[0]);
            const visibleRows = Array.from(document.querySelectorAll('#tableBody tr:not(.hidden-row)'));
            if (visibleRows[displayRow - 1]) {
                return visibleRows[displayRow - 1].dataset.rowNum;
            }
            return null;
        }

        function syncMetaData(cellId) {
            const col = cellId.match(/[A-Z]+/)[0];
            if (!isDataCol(col) || CONFIG.noMetaCols.includes(col)) return;
            
            const row = cellId.match(/\d+/)[0];
            const metaCol = getMetaCol(col);
            const metaCellId = `${metaCol}${row}`;
            
            const cell = document.getElementById(`cell-${cellId}`);
            let color = '';
            if (cell.classList.contains('cell-yellow')) color = 'ÈªÑËâ≤';
            else if (cell.classList.contains('cell-red')) color = 'Á∫¢Ëâ≤';
            else if (cell.classList.contains('cell-pink')) color = 'Á≤âËâ≤';
            
            const comment = cell.dataset.comment || '';
            const metaValue = color + (comment ? CONFIG.metaDataSeparator + comment : '');
            
            setCellData(metaCellId, metaValue);
        }

        function calculateDColumn() {
            for (let r = 1; r <= state.rows; r++) {
                let count = 0;
                CONFIG.countColForD.forEach(col => {
                    const cellId = `${col}${r}`;
                    if (state.data[cellId] && state.data[cellId].trim() !== '') {
                        count++;
                    }
                });
                setCellData(`D${r}`, count.toString());
            }
        }

        function checkDuplicates() {
            const excludeCols = ['C','D','E','F','G'];
            const valueMap = new Map();
            
            for (let r = 1; r <= state.rows; r++) {
                state.colLetters.forEach(col => {
                    if (!isDataCol(col) || excludeCols.includes(col)) return;
                    
                    const cellId = `${col}${r}`;
                    const value = (state.data[cellId] || '').trim();
                    if (!value) return;
                    
                    const num = parseFloat(value);
                    if (!isNaN(num) && num >= 0 && num <= 10) return;
                    
                    if (!valueMap.has(value)) valueMap.set(value, []);
                    valueMap.get(value).push(cellId);
                });
            }
            
            document.querySelectorAll('.duplicate-cell').forEach(el => {
                el.classList.remove('duplicate-cell');
            });
            
            valueMap.forEach((cellIds, value) => {
                if (cellIds.length > 1) {
                    cellIds.forEach(id => {
                        const cell = document.getElementById(`cell-${id}`);
                        if (cell) cell.classList.add('duplicate-cell');
                    });
                }
            });
        }

        // ==================== Ê†ºÂºèÂåñ ====================
        function formatCell(color) {
            const targets = state.selectedCells.size > 0 ? 
                Array.from(state.selectedCells) : 
                (state.selectedCell ? [state.selectedCell] : []);
            
            targets.forEach(cellId => {
                const col = cellId.match(/[A-Z]+/)[0];
                if (CONFIG.noMetaCols.includes(col)) return;
                
                const cell = document.getElementById(`cell-${cellId}`);
                cell.classList.remove('cell-yellow', 'cell-red', 'cell-pink');
                if (color !== 'clear') {
                    cell.classList.add(`cell-${color}`);
                }
                
                if (isDataCol(col) && !CONFIG.noMetaCols.includes(col)) {
                    syncMetaData(cellId);
                }
            });
            
            saveToHistory();
        }

        function clearCellFormat() {
            formatCell('clear');
        }

        // ==================== Â§áÊ≥®ÂäüËÉΩ ====================
        function addComment() {
            const cellId = state.selectedCell;
            if (!cellId) return;
            
            const col = cellId.match(/[A-Z]+/)[0];
            if (CONFIG.noMetaCols.includes(col)) {
                showToast('C-GÂàó‰∏çÊîØÊåÅÂ§áÊ≥®ÂäüËÉΩ');
                return;
            }
            
            const cell = document.getElementById(`cell-${cellId}`);
            const currentComment = cell.dataset.comment || '';
            
            const newComment = prompt('ËØ∑ËæìÂÖ•Â§áÊ≥®Ôºö', currentComment);
            if (newComment === null) return;
            
            if (newComment.trim()) {
                cell.dataset.comment = newComment.trim();
                if (!cell.querySelector('.comment-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'comment-indicator';
                    cell.appendChild(indicator);
                }
            } else {
                clearComment();
                return;
            }
            
            syncMetaData(cellId);
            saveToHistory();
        }

        function clearComment() {
            const cellId = state.selectedCell;
            if (!cellId) return;
            
            const col = cellId.match(/[A-Z]+/)[0];
            if (CONFIG.noMetaCols.includes(col)) return;
            
            const cell = document.getElementById(`cell-${cellId}`);
            delete cell.dataset.comment;
            const indicator = cell.querySelector('.comment-indicator');
            if (indicator) indicator.remove();
            
            syncMetaData(cellId);
            saveToHistory();
        }

        function showContextMenu(e, cellId) {
            e.preventDefault();
            selectCell(cellId);
            
            const menu = document.getElementById('contextMenu');
            let menuX = e.pageX;
            let menuY = e.pageY;
            
            const menuWidth = 261.36;
            const menuHeight = 420;
            
            if (menuX + menuWidth > window.innerWidth) {
                menuX = window.innerWidth - menuWidth - 10;
            }
            if (menuY + menuHeight > window.innerHeight) {
                menuY = window.innerHeight - menuHeight - 10;
            }
            if (menuY < 0) menuY = 10;
            
            menu.style.display = 'block';
            menu.style.left = menuX + 'px';
            menu.style.top = menuY + 'px';
        }

        // ==================== Ë°åÂàóÊìç‰Ωú ====================
        function addNewRow() {
            state.rows++;
            const tbody = document.getElementById('tableBody');
            const r = state.rows - 1;
            
            let html = `<tr data-row-num="${state.rows}"><th class="row-header" onclick="selectRow(${r})">${state.rows}</th>`;
            state.colLetters.forEach((col, idx) => {
                const isMeta = idx >= 20;
                const isReadOnly = CONFIG.readOnlyCol.includes(col);
                const cellId = `${col}${state.rows}`;
                const width = getColWidth(col, idx);
                const noResize = CONFIG.noResizeCols.includes(col);
                
                html += `
                    <td data-row="${r}" data-col="${col}" data-id="${cellId}" 
                        class="${isMeta ? 'meta-col' : ''} ${isReadOnly ? '' : 'editable'}"
                        style="width: ${width}px; min-width: ${width}px; ${noResize ? 'max-width: ' + width + 'px;' : ''}"
                        onclick="handleCellClick(event, '${cellId}')"
                        onmouseenter="highlightRow(${r}); showCommentTooltip(event, '${cellId}')"
                        onmouseleave="clearHighlight(); hideCommentTooltip()">
                        <div class="cell-content" id="cell-${cellId}"></div>
                    </td>
                `;
            });
            html += '</tr>';
            
            tbody.insertAdjacentHTML('beforeend', html);
            setCellData(`D${state.rows}`, '0');
            
            const container = document.getElementById('container');
            container.scrollTop = container.scrollHeight;
            
            saveToHistory();
        }

        function deleteSelectedRow() {
            if (!state.selectedCell) return;
            
            const rowNum = parseInt(state.selectedCell.match(/\d+/)[0]);
            
            state.colLetters.forEach(col => {
                const cellId = `${col}${rowNum}`;
                delete state.data[cellId];
            });
            
            for (let r = rowNum; r < state.rows; r++) {
                state.colLetters.forEach(col => {
                    const fromId = `${col}${r + 1}`;
                    const toId = `${col}${r}`;
                    state.data[toId] = state.data[fromId];
                    delete state.data[fromId];
                });
            }
            
            state.rows--;
            
            renderEmptyRows();
            
            Object.entries(state.data).forEach(([cellId, value]) => {
                const cell = document.getElementById(`cell-${cellId}`);
                if (cell) cell.textContent = value;
            });
            
            restoreStyles();
            
            calculateDColumn();
            checkDuplicates();
            clearAllSelections();
            saveToHistory();
        }

        function restoreStyles() {
            for (let r = 1; r <= state.rows; r++) {
                for (let c = 'A'; c <= 'T'; c = String.fromCharCode(c.charCodeAt(0) + 1)) {
                    if (CONFIG.noMetaCols.includes(c)) continue;
                    
                    const metaCol = getMetaCol(c);
                    const metaCellId = `${metaCol}${r}`;
                    const metaValue = state.data[metaCellId] || '';
                    
                    if (metaValue) {
                        const parts = metaValue.split(CONFIG.metaDataSeparator);
                        const color = parts[0];
                        const comment = parts[1];
                        
                        const cellId = `${c}${r}`;
                        const cell = document.getElementById(`cell-${cellId}`);
                        
                        if (color === 'ÈªÑËâ≤') cell.classList.add('cell-yellow');
                        else if (color === 'Á∫¢Ëâ≤') cell.classList.add('cell-red');
                        else if (color === 'Á≤âËâ≤') cell.classList.add('cell-pink');
                        
                        if (comment) {
                            cell.dataset.comment = comment;
                            if (!cell.querySelector('.comment-indicator')) {
                                const indicator = document.createElement('div');
                                indicator.className = 'comment-indicator';
                                cell.appendChild(indicator);
                            }
                        }
                    }
                }
            }
        }

        function clearSelectedCells() {
            const targets = state.selectedCells.size > 0 ? 
                Array.from(state.selectedCells) : 
                (state.selectedCell ? [state.selectedCell] : []);
            
            targets.forEach(cellId => {
                const col = cellId.match(/[A-Z]+/)[0];
                if (CONFIG.readOnlyCol.includes(col)) {
                    setCellData(cellId, '0');
                } else {
                    setCellData(cellId, '');
                }
            });
            
            calculateDColumn();
            saveToHistory();
        }

        // ==================== ÂàóÂÆΩË∞ÉÊï¥ ====================
        function startColResize(e, col) {
            if (CONFIG.noResizeCols.includes(col)) return;
            
            e.stopPropagation();
            
            let isResizing = true;
            const th = document.querySelector(`th[data-col="${col}"]`);
            const startX = e.clientX;
            const startWidth = th.offsetWidth;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                const newWidth = Math.max(20, startWidth + (e.clientX - startX));
                
                th.style.width = newWidth + 'px';
                th.style.minWidth = newWidth + 'px';
                
                document.querySelectorAll(`td[data-col="${col}"]`).forEach(td => {
                    td.style.width = newWidth + 'px';
                    td.style.minWidth = newWidth + 'px';
                });
            }
            
            function onMouseUp() {
                isResizing = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveToHistory();
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // ==================== ÂéÜÂè≤ËÆ∞ÂΩïÔºàÂ∑≤‰øÆÂ§çÔºöÂåÖÂê´ÁïåÈù¢Áä∂ÊÄÅÔºâ ====================
        function saveToHistory() {
            if (state.isUndoRedo) return;
            
            state.redoStack = [];
            if (state.historyStack.length >= CONFIG.maxHistory) {
                state.historyStack.shift();
            }
            
            // ‰øùÂ≠òÂÆåÊï¥ÁöÑÁïåÈù¢Áä∂ÊÄÅ
            state.historyStack.push({
                data: JSON.parse(JSON.stringify(state.data)),
                headerData: JSON.parse(JSON.stringify(state.headerData)),
                rows: state.rows,
                isFilterActive: state.isFilterActive,
                searchTerm: state.searchTerm
            });
            
            updateUndoRedoButtons();
        }

        function undo() {
            if (state.historyStack.length <= 1) return;
            
            state.isUndoRedo = true;
            state.redoStack.push(state.historyStack.pop());
            restoreState(state.historyStack[state.historyStack.length - 1]);
            state.isUndoRedo = false;
            
            updateUndoRedoButtons();
        }

        function redo() {
            if (state.redoStack.length === 0) return;
            
            state.isUndoRedo = true;
            const nextState = state.redoStack.pop();
            state.historyStack.push(nextState);
            restoreState(nextState);
            state.isUndoRedo = false;
            
            updateUndoRedoButtons();
        }

        function restoreState(savedState) {
            // ÊÅ¢Â§çÊï∞ÊçÆ
            state.data = JSON.parse(JSON.stringify(savedState.data));
            state.headerData = JSON.parse(JSON.stringify(savedState.headerData));
            state.rows = savedState.rows;
            
            // ÊÅ¢Â§çÁïåÈù¢Áä∂ÊÄÅ
            state.isFilterActive = savedState.isFilterActive;
            state.searchTerm = savedState.searchTerm;
            
            // Êõ¥Êñ∞UIÊéß‰ª∂
            const filterBtn = document.getElementById('filterToggle');
            const searchInput = document.getElementById('searchInput');
            
            if (state.isFilterActive) {
                filterBtn.classList.add('btn-active');
                filterBtn.textContent = 'ÊòæÁ§∫ÂÖ®ÈÉ®';
            } else {
                filterBtn.classList.remove('btn-active');
                filterBtn.textContent = 'Á≠õÈÄâÔºû0';
            }
            
            searchInput.value = state.searchTerm || '';
            
            // ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º
            Object.entries(state.headerData).forEach(([col, value]) => {
                const th = document.querySelector(`th[data-col="${col}"] .header-text`);
                if (th) th.textContent = value;
            });
            
            renderEmptyRows();
            
            Object.entries(state.data).forEach(([cellId, value]) => {
                const cell = document.getElementById(`cell-${cellId}`);
                if (cell) cell.textContent = value;
            });
            
            restoreStyles();
            calculateDColumn();
            checkDuplicates();
            
            // ÊÅ¢Â§çÁ≠õÈÄâ/ÊêúÁ¥¢Áä∂ÊÄÅ
            if (state.searchTerm) {
                performSearch();
            } else if (state.isFilterActive) {
                applyFilter();
            } else {
                document.querySelectorAll('#tableBody tr').forEach(tr => {
                    tr.classList.remove('hidden-row');
                });
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = state.historyStack.length <= 1;
            document.getElementById('redoBtn').disabled = state.redoStack.length === 0;
        }

        // ==================== ExcelÂØºÂÖ•ÂØºÂá∫ ====================
        async function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (state.editingCell) {
                endEdit();
            }
            
            state.data = {};
            state.headerData = {};
            state.selectedCell = null;
            state.selectedCells.clear();
            state.editingCell = null;
            state.activeInput = null;
            state.isFilterActive = false;
            state.searchTerm = '';
            state.filteredRows.clear();
            state.highlightedRow = null;
            state.historyStack = [];
            state.redoStack = [];
            state.isUndoRedo = false;
            
            document.getElementById('searchInput').value = '';
            const filterBtn = document.getElementById('filterToggle');
            filterBtn.classList.remove('btn-active');
            filterBtn.textContent = 'Á≠õÈÄâÔºû0';
            updateUndoRedoButtons();
            
            document.querySelectorAll('.cell-content.selected').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('tr.row-selected').forEach(tr => {
                tr.classList.remove('row-selected');
            });
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });
            document.querySelectorAll('tr.hidden-row').forEach(tr => {
                tr.classList.remove('hidden-row');
            });
            document.querySelectorAll('.row-highlight').forEach(el => {
                el.classList.remove('row-highlight');
            });
            
            document.getElementById('contextMenu').style.display = 'none';
            document.getElementById('commentPopup').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
            
            showLoading('Ê≠£Âú®ÂØºÂÖ•...');
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (jsonData.length > 0) {
                    const headers = jsonData[0];
                    headers.forEach((h, idx) => {
                        if (idx < state.colLetters.length && h) {
                            state.headerData[state.colLetters[idx]] = String(h);
                        }
                    });
                }
                
                const rows = jsonData.slice(1);
                state.rows = Math.max(rows.length, 100);
                renderEmptyRows();
                
                Object.entries(state.headerData).forEach(([col, value]) => {
                    const th = document.querySelector(`th[data-col="${col}"] .header-text`);
                    if (th) th.textContent = value;
                });
                
                rows.forEach((row, rIdx) => {
                    row.forEach((val, cIdx) => {
                        if (val !== undefined && val !== null && cIdx < state.colLetters.length) {
                            const col = state.colLetters[cIdx];
                            setCellData(`${col}${rIdx + 1}`, String(val));
                        }
                    });
                });
                
                calculateLHeader();
                calculateDColumn();
                checkDuplicates();
                saveToHistory();
                saveToLocalStorage();
                
                hideLoading();
                showToast(`ÊàêÂäüÂØºÂÖ• ${rows.length} Ë°åÊï∞ÊçÆ`);
            } catch (err) {
                hideLoading();
                showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
            }
            
            e.target.value = '';
        }

        function saveToExcel() {
            showLoading('Ê≠£Âú®ÂØºÂá∫...');
            
            try {
                const data = [];
                
                const header = state.colLetters.map(col => state.headerData[col] || col);
                data.push(header);
                
                for (let r = 1; r <= state.rows; r++) {
                    const row = [];
                    let hasData = false;
                    state.colLetters.forEach(col => {
                        const val = state.data[`${col}${r}`] || '';
                        row.push(val);
                        if (val) hasData = true;
                    });
                    if (hasData) data.push(row);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ËçØÂìÅÊï∞ÊçÆ');
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const filename = `ybÊï∞ÊçÆ${year}${month}${day} ${hours}${minutes}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showToast('ÂØºÂá∫ÊàêÂäü');
            } catch (err) {
                hideLoading();
                showToast('ÂØºÂá∫Â§±Ë¥•: ' + err.message);
            }
        }

        // ==================== Êú¨Âú∞Â≠òÂÇ® ====================
        function saveToLocalStorage() {
            try {
                const data = {
                    data: state.data,
                    headerData: state.headerData,
                    rows: state.rows,
                    version: '2.3'
                };
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
            } catch (e) {
                console.error('‰øùÂ≠òÂ§±Ë¥•:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(CONFIG.storageKey);
                if (!saved) return false;
                
                const parsed = JSON.parse(saved);
                state.data = parsed.data || {};
                state.headerData = parsed.headerData || {};
                state.rows = parsed.rows || 100;
                
                renderEmptyRows();
                
                Object.entries(state.headerData).forEach(([col, value]) => {
                    const th = document.querySelector(`th[data-col="${col}"] .header-text`);
                    if (th) th.textContent = value;
                });
                
                Object.entries(state.data).forEach(([cellId, value]) => {
                    const cell = document.getElementById(`cell-${cellId}`);
                    if (cell) cell.textContent = value;
                });
                
                calculateLHeader();
                calculateDColumn();
                checkDuplicates();
                restoreStyles();
                return true;
            } catch (e) {
                console.error('Âä†ËΩΩÂ§±Ë¥•:', e);
                return false;
            }
        }

        // ==================== ËæÖÂä©ÂáΩÊï∞ ====================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function initSampleData() {
            setCellData('A1', '6934114761936');
            setCellData('B1', 'btÁîüËÑâÈ•ÆÂÖöÂèÇÊñπÁõæÂÖãÂ∫∑Á¶è');
            setCellData('C1', '62');
            setCellData('E1', '35');
            setCellData('J1', '240');
            setCellData('K1', '126.8');
            
            document.getElementById('cell-B1').classList.add('cell-yellow');
            document.getElementById('cell-C1').classList.add('cell-yellow');
            
            calculateDColumn();
        }

        function handleGlobalKeydown(e) {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            } else if (e.key === 'Delete' && state.selectedCell && !state.editingCell) {
                e.preventDefault();
                clearSelectedCells();
            } else if (e.key === 'F2' && state.selectedCell && !state.editingCell) {
                e.preventDefault();
                startEdit(state.selectedCell);
            } else if (e.key === 'Enter' && state.editingCell) {
                e.preventDefault();
                endEdit();
                moveToNextCell();
            } else if (e.key === 'Escape' && state.editingCell) {
                e.preventDefault();
                const cell = document.getElementById(`cell-${state.editingCell}`);
                cell.textContent = state.data[state.editingCell] || '';
                endEdit();
            }
        }

        function initDragSelection() {
            // ÊãñÊãΩÈÄâÊã©ÂäüËÉΩ
        }

        function closeCommentPopup() {
            document.getElementById('commentPopup').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        }
    </script>
</body>
</html>
